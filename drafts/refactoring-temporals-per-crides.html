<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Apunts tècnics: Refactoring: Temporals per crides</title>
<meta name="description" content="">
<meta name="author" content="Moisès Gómez Girón">

<!-- HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
        <script src="../theme/html5.js"></script>
    <![endif]-->

<!-- Styles -->
<link href="../theme/bootstrap.moi.css" rel="stylesheet">
<link href="../theme/local.css" rel="stylesheet">
<link href="../theme/pygments.css" rel="stylesheet">

<!-- Feeds -->
<link href="http://apuntstecnics.herokuapp.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Apunts tècnics Atom Feed" />

</head>
<body>

<div class="topbar">
    <div class="topbar-inner">
        <div class="container-fluid">
            <a class="brand" href="../">[Apunts tècnics]
 Refactoring: Temporals per crides             </a>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="sidebar">
        <div class="well">
            <!--
            <h3>Temes</h3>
                <ul>
                </ul>
            -->
            <h3>Categories</h3>
            <ul>
                <li class="active"><a href="../category/dev.html">dev</a></li>
                <li ><a href="../category/eines.html">eines</a></li>
                <li ><a href="../category/misc.html">misc</a></li>
                <li ><a href="../category/poo.html">poo</a></li>
                <li ><a href="../category/programacio.html">programacio</a></li>
                <li ><a href="../category/uml.html">uml</a></li>
            </ul>
            <h3>Tags</h3>
            <ul>
                <li><a href="../tag/util.html">util</a></li>
                <li><a href="../tag/programari.html">programari</a></li>
                <li><a href="../tag/c.html">C</a></li>
                <li><a href="../tag/java.html">java</a></li>
            </ul>
        </div>
    </div>

    <div class="content">
<div class='article'>
    <div class="page-header"><h1>Refactoring: Temporals per crides</h1></div>
<div class="well small">
    Entrada ubicada a la categoria
    <a href="../category/dev.html">
        dev
    </a>
            amb els tags: 
            <a href="../tag/programari.html">programari</a> 
            <a href="../tag/java.html">java</a> 
</div>
    <div><div class="section" id="introduccio">
<h2>Introducció</h2>
<p>En aquesta entrada relitza un nou pas de refacció conegut com a
<em>reemplaçament de variable temporal per crida</em>.</p>
</div>
<div class="section" id="reemplaca-temporal-per-crida">
<h2>Reemplaça temporal per crida</h2>
<p>El següent pas de refacció cerca eliminar variables temporals que
només són assignades un cop i substituir-les pel valor assignat allà
on calgui.</p>
<p>Per exemple, considera el següent fragment de codi:</p>
<div class="highlight"><pre><span class="kt">int</span> <span class="n">preuBase</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">quantitat</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">preuUnitari</span><span class="o">;</span>
<span class="k">if</span> <span class="o">(</span><span class="n">preuBase</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">preuBase</span> <span class="o">*</span> <span class="mf">0.90</span><span class="o">;</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">preuBase</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>Aquest pas el codificaria com:</p>
<!-- code-block::java

if (preuBase() > 1000) {
    return preuBase() * 0.90;
} else {
    return preuBase();
} -->
<p>Amb el nou mètode que encapsula l'expressió inicial:</p>
<div class="highlight"><pre><span class="kt">double</span> <span class="nf">preuBase</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">quantitat</span> <span class="o">+</span> <span class="k">this</span><span class="o">.</span><span class="na">preuUnitari</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>La creació del nou mètode és un altre exemple de pas d'<em>extracció de
mètode</em> que hem vist abans.</p>
<p>Es pot argumentar que aquesta transformació resulta en un codi menys
eficient en execució. És cert, el preu base passa a calcular-se dos
cops en comptes d'un. En aquest cas, el càlcul és molt lleuger, però
podria ser més costós si incorporés, per exemple, un recorregut d'una
llista d'elements.</p>
<p>A favor del canvi, podem dir que elimina del codi dependències a
variables temporals. D'aquesta manera pot resultar molt més fàcil
realitzar extraccions de mètodes.</p>
<p>Recordem que l'eficiència en la llegibilitat/modificabilitat del codi
és normalment molt més desitjable que l'eficiència en l'execució de
codi. Abans de decidir-nos per un codi menys llegible justificant-lo
amb el rendiment em execució, és important tenir molt clar com afecta
al rendiment de l'aplicació. Molts cops ens trobarem que el guany de
rendiment és molt petit. D'altres cops veurem que el codi més clar
permet optimitzacions a més alt nivell.</p>
<p>En el codi que estem treballant, al mètode <tt class="docutils literal">Client.informe()</tt> hi
trobem la variable <tt class="docutils literal">quantitat</tt>.</p>
<div class="highlight"><pre><span class="lineno"> 1</span> <span class="kd">public</span> <span class="n">String</span> <span class="nf">informe</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="kt">double</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno"> 3</span>     <span class="kt">int</span> <span class="n">bonificacions</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno"> 4</span>     <span class="n">String</span> <span class="n">resultat</span> <span class="o">=</span> <span class="s">&quot;Informe de lloguers del client &quot;</span> <span class="o">+</span>
<span class="lineno"> 5</span>         <span class="n">getNom</span><span class="o">()</span> <span class="o">+</span>
<span class="lineno"> 6</span>         <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">getNif</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;)\n&quot;</span><span class="o">;</span>
<span class="lineno"> 7</span>     <span class="k">for</span> <span class="o">(</span><span class="n">Lloguer</span> <span class="nl">lloguer:</span> <span class="n">lloguers</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>         <span class="c1">// afegeix lloguers freqüents</span>
<span class="lineno"> 9</span>         <span class="n">bonificacions</span> <span class="o">++;</span>
<span class="lineno">10</span> 
<span class="lineno">11</span>         <span class="c1">// afegeix bonificació per dos dies de lloguer de Luxe</span>
<span class="lineno">12</span>         <span class="k">if</span> <span class="o">(</span><span class="n">lloguer</span><span class="o">.</span><span class="na">getVehicle</span><span class="o">().</span><span class="na">getCategoria</span><span class="o">()</span> <span class="o">==</span> <span class="n">Vehicle</span><span class="o">.</span><span class="na">LUXE</span> <span class="o">&amp;&amp;</span>
<span class="lineno">13</span>                 <span class="n">lloguer</span><span class="o">.</span><span class="na">getDies</span><span class="o">()&gt;</span><span class="mi">1</span> <span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span>             <span class="n">bonificacions</span> <span class="o">++;</span>
<span class="lineno">15</span>         <span class="o">}</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>         <span class="c1">// composa els resultats d&#39;aquest lloguer</span>
<span class="lineno">18</span>         <span class="n">resultat</span> <span class="o">+=</span> <span class="s">&quot;\t&quot;</span> <span class="o">+</span>
<span class="lineno">19</span>             <span class="n">lloguer</span><span class="o">.</span><span class="na">getVehicle</span><span class="o">().</span><span class="na">getMarca</span><span class="o">()</span> <span class="o">+</span>
<span class="lineno">20</span>             <span class="s">&quot; &quot;</span> <span class="o">+</span>
<span class="lineno">21</span>             <span class="n">lloguer</span><span class="o">.</span><span class="na">getVehicle</span><span class="o">().</span><span class="na">getModel</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span>
<span class="lineno">22</span> <span class="hll">            <span class="o">(</span><span class="n">lloguer</span><span class="o">.</span><span class="na">quantitat</span><span class="o">()</span> <span class="o">*</span> <span class="mi">30</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;€&quot;</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">;</span>
</span><span class="lineno">23</span> <span class="hll">        <span class="n">total</span> <span class="o">+=</span> <span class="n">lloguer</span><span class="o">.</span><span class="na">quantitat</span><span class="o">()</span> <span class="o">*</span> <span class="mi">30</span><span class="o">;</span>
</span><span class="lineno">24</span>     <span class="o">}</span>
<span class="lineno">25</span> 
<span class="lineno">26</span>     <span class="c1">// afegeix informació final</span>
<span class="lineno">27</span>     <span class="n">resultat</span> <span class="o">+=</span> <span class="s">&quot;Import a pagar: &quot;</span> <span class="o">+</span> <span class="n">total</span> <span class="o">+</span> <span class="s">&quot;€\n&quot;</span> <span class="o">+</span>
<span class="lineno">28</span>         <span class="s">&quot;Punts guanyats: &quot;</span> <span class="o">+</span> <span class="n">bonificacions</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">;</span>
<span class="lineno">29</span>     <span class="k">return</span> <span class="n">resultat</span><span class="o">;</span>
<span class="lineno">30</span> <span class="o">}</span>
</pre></div>
<div class="section" id="exercici-10-opcional-optimitzacio-del-calcul-de-quantitat">
<h3>Exercici 10: (opcional) Optimització del càlcul de quantitat</h3>
<p>Encara amb preocupacions per la pèrdua d'eficiència en execució del
pas anterior?</p>
<p>Et proposo que trobis alguna manera d'aconseguir que el valor tornat
per <tt class="docutils literal">Lloguer.quantitat()</tt> només es calculi un cop.</p>
</div>
<div class="section" id="exercici-11-extraccio-del-calcul-de-bonificacions">
<h3>Exercici 11: Extracció del càlcul de bonificacions</h3>
<p>De la mateixa manera que hem extret de <tt class="docutils literal">Client.informe()</tt> el càlcul
de l'import de cada lloguer, podem plantejar-nos extreure el càlcul de
les bonificacions.</p>
<p>En aquest cas, la bonificació es modifica en dos llocs, a banda de
la inicialització, segons es ressalta al codi:</p>
<div class="highlight"><pre><span class="lineno"> 1</span>  <span class="kd">public</span> <span class="n">String</span> <span class="nf">informe</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 2</span>      <span class="kt">double</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno"> 3</span> <span class="hll">     <span class="kt">int</span> <span class="n">bonificacions</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span><span class="lineno"> 4</span>      <span class="n">String</span> <span class="n">resultat</span> <span class="o">=</span> <span class="s">&quot;Informe de lloguers del client &quot;</span> <span class="o">+</span>
<span class="lineno"> 5</span>          <span class="n">getNom</span><span class="o">()</span> <span class="o">+</span>
<span class="lineno"> 6</span>          <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">getNif</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;)\n&quot;</span><span class="o">;</span>
<span class="lineno"> 7</span>      <span class="k">for</span> <span class="o">(</span><span class="n">Lloguer</span> <span class="nl">lloguer:</span> <span class="n">lloguers</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span>          <span class="c1">// afegeix lloguers freqüents</span>
<span class="lineno"> 9</span> <span class="hll">         <span class="n">bonificacions</span> <span class="o">++;</span>
</span><span class="lineno">10</span> 
<span class="lineno">11</span>          <span class="c1">// afegeix bonificació per dos dies de lloguer de Luxe</span>
<span class="lineno">12</span>          <span class="k">if</span> <span class="o">(</span><span class="n">lloguer</span><span class="o">.</span><span class="na">getVehicle</span><span class="o">().</span><span class="na">getCategoria</span><span class="o">()</span> <span class="o">==</span> <span class="n">Vehicle</span><span class="o">.</span><span class="na">LUXE</span> <span class="o">&amp;&amp;</span>
<span class="lineno">13</span>                  <span class="n">lloguer</span><span class="o">.</span><span class="na">getDies</span><span class="o">()&gt;</span><span class="mi">1</span> <span class="o">)</span> <span class="o">{</span>
<span class="lineno">14</span> <span class="hll">             <span class="n">bonificacions</span> <span class="o">++;</span>
</span><span class="lineno">15</span>                  <span class="o">}</span>
<span class="lineno">16</span> 
<span class="lineno">17</span>          <span class="c1">// composa els resultats d&#39;aquest lloguer</span>
<span class="lineno">18</span>          <span class="n">resultat</span> <span class="o">+=</span> <span class="s">&quot;\t&quot;</span> <span class="o">+</span>
<span class="lineno">19</span>              <span class="n">lloguer</span><span class="o">.</span><span class="na">getVehicle</span><span class="o">().</span><span class="na">getMarca</span><span class="o">()</span> <span class="o">+</span>
<span class="lineno">20</span>              <span class="s">&quot; &quot;</span> <span class="o">+</span>
<span class="lineno">21</span>              <span class="n">lloguer</span><span class="o">.</span><span class="na">getVehicle</span><span class="o">().</span><span class="na">getModel</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span>
<span class="lineno">22</span>              <span class="o">(</span><span class="n">lloguer</span><span class="o">.</span><span class="na">quantitat</span><span class="o">()</span> <span class="o">*</span> <span class="mi">30</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;€&quot;</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">;</span>
<span class="lineno">23</span>          <span class="n">total</span> <span class="o">+=</span> <span class="n">lloguer</span><span class="o">.</span><span class="na">quantitat</span><span class="o">()</span> <span class="o">*</span> <span class="mi">30</span><span class="o">;</span>
<span class="lineno">24</span>      <span class="o">}</span>
<span class="lineno">25</span> 
<span class="lineno">26</span>      <span class="c1">// afegeix informació final</span>
<span class="lineno">27</span>      <span class="n">resultat</span> <span class="o">+=</span> <span class="s">&quot;Import a pagar: &quot;</span> <span class="o">+</span> <span class="n">total</span> <span class="o">+</span> <span class="s">&quot;€\n&quot;</span> <span class="o">+</span>
<span class="lineno">28</span>          <span class="s">&quot;Punts guanyats: &quot;</span> <span class="o">+</span> <span class="n">bonificacions</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">;</span>
<span class="lineno">29</span>      <span class="k">return</span> <span class="n">resultat</span><span class="o">;</span>
<span class="lineno">30</span>  <span class="o">}</span>
</pre></div>
<p>Extreu la funcionalitat del càlcul de les bonificacions a un nou
mètode <tt class="docutils literal">bonificacioPerLloguer()</tt> que donat un lloguer retorna la
bonificació corresponent.</p>
<p>En fer-ho, assegura't que no has trencat res i que guardes la versió
al control de versions.</p>
<p>El mètode <tt class="docutils literal">Client.informe()</tt> haurà de resultar així:</p>
<div class="highlight"><pre><span class="lineno"> 1</span> <span class="kd">public</span> <span class="n">String</span> <span class="nf">informe</span><span class="o">()</span> <span class="o">{</span>
<span class="lineno"> 2</span>     <span class="kt">double</span> <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno"> 3</span>     <span class="kt">int</span> <span class="n">bonificacions</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
<span class="lineno"> 4</span>     <span class="n">String</span> <span class="n">resultat</span> <span class="o">=</span> <span class="s">&quot;Informe de lloguers del client &quot;</span> <span class="o">+</span>
<span class="lineno"> 5</span>         <span class="n">getNom</span><span class="o">()</span> <span class="o">+</span>
<span class="lineno"> 6</span>         <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">getNif</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;)\n&quot;</span><span class="o">;</span>
<span class="lineno"> 7</span>     <span class="k">for</span> <span class="o">(</span><span class="n">Lloguer</span> <span class="nl">lloguer:</span> <span class="n">lloguers</span><span class="o">)</span> <span class="o">{</span>
<span class="lineno"> 8</span> <span class="hll">        <span class="n">bonificacions</span> <span class="o">+=</span> <span class="n">lloguer</span><span class="o">.</span><span class="na">bonificacionsDeLLoguer</span><span class="o">(</span><span class="n">lloguer</span><span class="o">);</span>
</span><span class="lineno"> 9</span>         <span class="c1">// composa els resultats d&#39;aquest lloguer</span>
<span class="lineno">10</span>         <span class="n">resultat</span> <span class="o">+=</span> <span class="s">&quot;\t&quot;</span> <span class="o">+</span>
<span class="lineno">11</span>             <span class="n">lloguer</span><span class="o">.</span><span class="na">getVehicle</span><span class="o">().</span><span class="na">getMarca</span><span class="o">()</span> <span class="o">+</span>
<span class="lineno">12</span>             <span class="s">&quot; &quot;</span> <span class="o">+</span>
<span class="lineno">13</span>             <span class="n">lloguer</span><span class="o">.</span><span class="na">getVehicle</span><span class="o">().</span><span class="na">getModel</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot;: &quot;</span> <span class="o">+</span>
<span class="lineno">14</span>             <span class="o">(</span><span class="n">lloguer</span><span class="o">.</span><span class="na">quantitat</span><span class="o">()</span> <span class="o">*</span> <span class="mi">30</span><span class="o">)</span> <span class="o">+</span> <span class="s">&quot;€&quot;</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">;</span>
<span class="lineno">15</span>         <span class="n">total</span> <span class="o">+=</span> <span class="n">lloguer</span><span class="o">.</span><span class="na">quantitat</span><span class="o">()</span> <span class="o">*</span> <span class="mi">30</span><span class="o">;</span>
<span class="lineno">16</span>     <span class="o">}</span>
<span class="lineno">17</span> 
<span class="lineno">18</span>     <span class="c1">// afegeix informació final</span>
<span class="lineno">19</span>     <span class="n">resultat</span> <span class="o">+=</span> <span class="s">&quot;Import a pagar: &quot;</span> <span class="o">+</span> <span class="n">total</span> <span class="o">+</span> <span class="s">&quot;€\n&quot;</span> <span class="o">+</span>
<span class="lineno">20</span>         <span class="s">&quot;Punts guanyats: &quot;</span> <span class="o">+</span> <span class="n">bonificacions</span> <span class="o">+</span> <span class="s">&quot;\n&quot;</span><span class="o">;</span>
<span class="lineno">21</span>     <span class="k">return</span> <span class="n">resultat</span><span class="o">;</span>
<span class="lineno">22</span> <span class="o">}</span>
</pre></div>
<hr class="docutils" />
<p>Passem a veure <a class="reference external" href="../refactoring-moviment-de-responsabilitat.html">un altre exemple típic</a> de refacció.</p>
</div>
</div>
</div>
</div>
<footer>
  <p>
  <a href="..">Apunts tècnics</a> 
  &copy; 
  <a href="http://www.gnu.org/copyleft/fdl.html">GNU FDL</a>
  per <i>Moisès Gómez Girón </i> (<img style="position:relative;top:+5px;border:0; display:inline;" src="../images/adressamoi.png">)
  amb el generador de blocs <a href="http://getpelican.com/">Pelican</a> 
  </p>
</footer>    </div>
</div>

</body>
</html>