<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Apunts tècnics: Subdocuments</title>
<meta name="description" content="">
<meta name="author" content="Moisès Gómez Girón">

<!-- HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
        <script src="../theme/html5.js"></script>
    <![endif]-->

<!-- Styles -->
<link href="../theme/bootstrap.moi.css" rel="stylesheet">
<link href="../theme/local.css" rel="stylesheet">
<link href="../theme/pygments.css" rel="stylesheet">

<!-- Feeds -->
<link href="http://apuntstecnics.herokuapp.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Apunts tècnics Atom Feed" />

</head>
<body>

<div class="topbar">
    <div class="topbar-inner">
        <div class="container-fluid">
            <a class="brand" href="../">[Apunts tècnics]
 Subdocuments             </a>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="sidebar">
        <div class="well">
            <!--
            <h3>Temes</h3>
                <ul>
                </ul>
            -->
            <h3>Categories</h3>
            <ul>
                <li class="active"><a href="../category/bd.html">bd</a></li>
                <li ><a href="../category/dev.html">dev</a></li>
                <li ><a href="../category/eines.html">eines</a></li>
                <li ><a href="../category/misc.html">misc</a></li>
                <li ><a href="../category/poo.html">poo</a></li>
                <li ><a href="../category/programacio.html">programacio</a></li>
                <li ><a href="../category/uml.html">uml</a></li>
            </ul>
            <h3>Tags</h3>
            <ul>
                <li><a href="../tag/c.html">C</a></li>
                <li><a href="../tag/java.html">java</a></li>
                <li><a href="../tag/programari.html">programari</a></li>
                <li><a href="../tag/util.html">util</a></li>
                <li><a href="../tag/test.html">test</a></li>
                <li><a href="../tag/postgresql.html">PostGreSQL</a></li>
            </ul>
        </div>
    </div>

    <div class="content">
<div class='article'>
    <div class="page-header"><h1>Subdocuments</h1></div>
<div class="well small">
    Entrada ubicada a la categoria
    <a href="../category/bd.html">
        bd
    </a>
            amb el tag:
            <a href="../tag/mongodb.html">mongoDB</a> 
        (Darrera modificació: <b> 9/4/2014 </b>)
</div>
    <div><div class="section" id="introduccio">
<h2>Introducció</h2>
<p>Fins ara, als exemples amb que hem treballat les claus tenien sempre
com a valor un número o un string.</p>
<p>MongoDB ens permet que el valor pugui ser també un altre document.
Veurem aquí el com.</p>
</div>
<div class="section" id="id1">
<h2>Subdocuments</h2>
<p>De vegades, ens interessarà guardar valors complexos per a algunes
claus.</p>
<p>Per exemple, considera una adreça postal al territori espanyol. Els
elements que habitualment guardem es podrien resumir en:</p>
<ul class="simple">
<li>carrer: carrer, plaça o vía.</li>
<li>població: barri, aldea o entitat inferior de població.</li>
<li>codi postal: cinc dígits on els 2 primers indiquen la província i la resta a la localitat o districte.</li>
<li>localitat</li>
<li>província: encara que el codi postal ja la inclou</li>
</ul>
<p>Veiem alguns exemples en format json:</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;carrer&quot;</span><span class="o">:</span>      <span class="s2">&quot;Únic S/N&quot;</span><span class="p">,</span>
    <span class="s2">&quot;població&quot;</span><span class="o">:</span>    <span class="s2">&quot;Berrós Jussà&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cp&quot;</span><span class="o">:</span>          <span class="s2">&quot;25597&quot;</span><span class="p">,</span>
    <span class="s2">&quot;localitat&quot;</span><span class="o">:</span>   <span class="s2">&quot;La Guingueta d&#39;Àneu&quot;</span><span class="p">,</span>
    <span class="s2">&quot;província&quot;</span><span class="o">:</span>   <span class="s2">&quot;Lleida&quot;</span>
<span class="p">}</span>
<span class="p">{</span>
    <span class="s2">&quot;carrer&quot;</span><span class="o">:</span>      <span class="s2">&quot;Carrer de la Selva de Mar, 211&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cp&quot;</span><span class="o">:</span>          <span class="s2">&quot;08020&quot;</span><span class="p">,</span>
    <span class="s2">&quot;localitat&quot;</span><span class="o">:</span>   <span class="s2">&quot;Barcelona&quot;</span><span class="p">,</span>
    <span class="s2">&quot;província&quot;</span><span class="o">:</span>   <span class="s2">&quot;Barcelona&quot;</span>
<span class="p">}</span>
</pre></div>
<p>Fixa't que al segon exemple <em>població</em> apareix buida. Recorda que a
MongoDB els documents són molt flexibles. Fins i tot podríem guardar a
la mateixa col·lecció el codi postal uns cops amb valors numèrics,
d'altres amb strings o fins, etc. Per simplicitat, els exemples que
treballarem en aquests articles no barrejaran tipus i mantindran una
estructura homogènia en tots els documents d'una col·lecció
<a class="footnote-reference" href="#perquesimplifica" id="id2">[1]</a>.</p>
<p>Ara és quan bé la part interessant. Imagina que vols assignar una
adreça a una persona <a class="footnote-reference" href="#collecciopersones" id="id3">[2]</a>.</p>
<p>Evidentment podem afegir al registre de la persona els diferents camps
que composen l'adreça:</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;nom&quot;</span><span class="o">:</span>         <span class="s2">&quot;Jordi Navarro Cucurella&quot;</span><span class="p">,</span>
    <span class="s2">&quot;edat&quot;</span><span class="o">:</span>        <span class="mi">32</span><span class="p">,</span>
    <span class="s2">&quot;professió&quot;</span><span class="o">:</span>   <span class="s2">&quot;alcalde&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sou&quot;</span><span class="o">:</span>         <span class="mi">320</span><span class="p">,</span>
    <span class="s2">&quot;carrer&quot;</span><span class="o">:</span>      <span class="s2">&quot;Únic S/N&quot;</span><span class="p">,</span>
    <span class="s2">&quot;població&quot;</span><span class="o">:</span>    <span class="s2">&quot;Berrós Jussà&quot;</span><span class="p">,</span>
    <span class="s2">&quot;cp&quot;</span><span class="o">:</span>          <span class="s2">&quot;25597&quot;</span><span class="p">,</span>
    <span class="s2">&quot;localitat&quot;</span><span class="o">:</span>   <span class="s2">&quot;La Guingueta d&#39;Àneu&quot;</span><span class="p">,</span>
    <span class="s2">&quot;província&quot;</span><span class="o">:</span>   <span class="s2">&quot;Lleida&quot;</span>
<span class="p">}</span>
</pre></div>
<p>Què passaria, però, si necessitéssim dues adreces? Per exemple,
la nostra aplicació podria requerir una adreça d'enviament i una de
facturació.</p>
<p>D'acord, sempre podem fer camps de l'estil <em>carrerfact</em> i <em>carrerenv</em>.
Tot i que hi ha moltes aplicacions funcionant així, espero que estaràs
d'acord que, com a mínim, no resulta gaire elegant.</p>
<p>Intentem una nova via: incloure les dades de l'adreça com a valor
d'<strong>un</strong> camp de persona. El resultat tindria el següent aspecte:</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;nom&quot;</span><span class="o">:</span>         <span class="s2">&quot;Jordi Navarro Cucurella&quot;</span><span class="p">,</span>
    <span class="s2">&quot;edat&quot;</span><span class="o">:</span>        <span class="mi">32</span><span class="p">,</span>
    <span class="s2">&quot;professió&quot;</span><span class="o">:</span>   <span class="s2">&quot;alcalde&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sou&quot;</span><span class="o">:</span>         <span class="mi">320</span><span class="p">,</span>
    <span class="s2">&quot;adreça&quot;</span><span class="o">:</span>      <span class="p">{</span>
                        <span class="s2">&quot;carrer&quot;</span><span class="o">:</span>      <span class="s2">&quot;Únic S/N&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;població&quot;</span><span class="o">:</span>    <span class="s2">&quot;Berrós Jussà&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;cp&quot;</span><span class="o">:</span>          <span class="s2">&quot;25597&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;localitat&quot;</span><span class="o">:</span>   <span class="s2">&quot;La Guingueta d&#39;Àneu&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;província&quot;</span><span class="o">:</span>   <span class="s2">&quot;Lleida&quot;</span>
                    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<div class="section" id="exercici-1-persones-adrecades">
<h3>Exercici 1. Persones adreçades</h3>
<p>Elimina, si et cal, l'antiga col·lecció de <em>persones</em> i crea una de
nova amb el document de l'exemple anterior.</p>
<p>Afegeix al menys tres nous registres amb el nom de companys que seguin
a prop teu a classe (incloent el teu nom entre ells). Inventa't la
resta de les dades si et cal.</p>
</div>
<div class="section" id="seleccio-segons-un-camp-d-un-subdocument">
<h3>Selecció segons un camp d'un subdocument</h3>
<p>El mètode <em>find</em> ens permet especificar subcamps tant al document de
sel·lecció (primer argument) com al de projecció (segon argument). Per
exemple:</p>
<div class="highlight"><pre><span class="lineno"> 1 </span><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">persones</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span>
<span class="lineno"> 2 </span>    <span class="p">{</span><span class="s2">&quot;adreça.província&quot;</span><span class="o">:</span><span class="s2">&quot;Lleida&quot;</span><span class="p">},</span>
<span class="lineno"> 3 </span>    <span class="p">{</span><span class="nx">nom</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;adreça.província&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span> <span class="nx">_id</span><span class="o">:</span><span class="mi">0</span><span class="p">}</span>
<span class="lineno"> 4 </span>  <span class="p">).</span><span class="nx">pretty</span><span class="p">()</span>
<span class="lineno"> 5 </span><span class="p">{</span>
<span class="lineno"> 6 </span>    <span class="s2">&quot;nom&quot;</span> <span class="o">:</span> <span class="s2">&quot;Jordi Navarro Cucurella&quot;</span><span class="p">,</span>
<span class="lineno"> 7 </span>    <span class="s2">&quot;adreça&quot;</span> <span class="o">:</span> <span class="p">{</span>
<span class="lineno"> 8 </span>        <span class="s2">&quot;província&quot;</span> <span class="o">:</span> <span class="s2">&quot;Lleida&quot;</span>
<span class="lineno"> 9 </span>    <span class="p">}</span>
<span class="lineno">10 </span><span class="p">}</span>
</pre></div>
<p>Tant a la sel·lecció com a la projecció hem especificat el subcamp a
partir del nom de la clau i el nom del subcamp separats amb un punt
(<em>adreça.provícia</em>). Fins ara, si la clau no contenia cap caràcter
<em>especial</em>, podíem ometre les cometes (ex. Fixa't com a la línia 3 no
posem entre cometes ni el nom ni l'identificador). Amb els subcamps
<em>sempre</em> haurem de fer servir les cometes.</p>
</div>
<div class="section" id="exercici-2-practica-de-consulta-de-subcamps">
<h3>Exercici 2. Practica de consulta de subcamps</h3>
<p>A partir de les dades que has introduït a l'exercici anterior (on
hauria d'haver com a mínim 4 entrades), composa una consulta que
mostri la segona persona més jove de la col·lecció.</p>
<p>En volem saber només el nom, l'edat, la professió, el codi postal i la
localitat.</p>
</div>
<div class="section" id="modificacio-del-valor-d-un-camp-d-un-subdocument">
<h3>Modificació del valor d'un camp d'un subdocument</h3>
<p>No esperis gaires novetats en aquest apartat. Pel mètode <em>update</em>
l'especificació d'un subcamp es realitza igual que per a <em>find</em>.</p>
<p>Així, si volem canviar el carrer del Sr. Jordi Navarro dels exemples
anteriors, farem:</p>
<div class="highlight"><pre><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">persones</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span>
    <span class="p">{</span><span class="nx">nom</span><span class="o">:</span> <span class="s2">&quot;Jordi Navarro Cucurella&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;adreça.carrer&quot;</span><span class="o">:</span><span class="s2">&quot;Carretera d&#39;Àneu, 21 5é 1ra&quot;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">)</span>
</pre></div>
</div>
<div class="section" id="exercici-3-el-sr-navarro-canvia-de-poble">
<h3>Exercici 3. El Sr. Navarro canvia de poble</h3>
<p>El Sr. Navarro, dels exemples anteriors, s'ha fet alcalde d'un poble
del costat <em>Esterri d'Àneu</em>. Ara la seva nova adreça és:</p>
<ul class="simple">
<li>carrer: Major, 6</li>
<li>població: Esterri d'Àneu</li>
<li>codi posta: 25580</li>
<li>localitat: Esterri d'Àneu</li>
<li>província: Lleida</li>
</ul>
<p>Ah! No et pensis que el Jordi fa les coses perquè sí. Amb el canvi,
també ha millorat les seves condicions econòmiques. Ara passa a cobrar
372€!</p>
<p>Aprofitarem per corregir un petit error amb les dades anteriors. La
professió del Sr. Navarro no està normalitzada. Si et fixes, hem
volgut mantenir les versions masculina i femenina a la resta de
professions. Així, canviarem la professió per <em>alcalde/ssa</em>.</p>
</div>
<div class="section" id="exercici-4-estudiants-amb-sou">
<h3>Exercici 4. Estudiants amb sou?</h3>
<p>Importa les dades d'<a class="reference external" href="../resources/persones02.json">aquest fitxer</a> a la col·lecció <em>persones</em>
<a class="footnote-reference" href="#dadesficticies" id="id4">[3]</a>.  Assegura't que elimines les dades anteriors.</p>
<p>El Molt Honorable President de la Generalitat de Catalunya ha tingut
accés a les dades de la col·lecció <em>persones</em> i s'ha quedat preocupat
pel reduït nombre d'estudiants a la província de Lleida.</p>
<p>Per mirar de promocionar l'estudi en aquests territori, i donat que li
sobraven uns eurillos <a class="footnote-reference" href="#ningushocreuaixo" id="id5">[4]</a>, ha decidit oferir un sou
de 100€ als estudiants amb adreça a Lleida.</p>
<p>Crea una crida al mètode <em>update</em> que permeti satisfer la decisió del
Molt Honorable.</p>
</div>
<div class="section" id="exercici-5-fusio-de-codis-postals">
<h3>Exercici 5. Fusió de codis postals</h3>
<p>Per alguna raó administrativa que se'ns escapa, els codis postals
d'algunes localitats lleidatanes han estat agrupats en un: el 25264.</p>
<p>Construeix una crida a <em>update</em> que modifiqui els registres amb codi
postal 25133, 25749 i 25282, de manera que passin a tenir el codi
postal unificat.</p>
<p><em>Pista</em>: el nombre d'entrades resultants amb codi postal 25264 haurà
de ser 4.</p>
</div>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<table class="docutils footnote" frame="void" id="perquesimplifica" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[1]</a></td><td>Aquesta és una simplificació per a aquests
materials. MongoDB es manega d'una manera molt senzilla amb
aquestes variacions.  Malauradament, les limitacions de temps de la
unitat formativa a la que estan adreçats aquests materials obliguen
a retallar molts aspectes resolts a MongoDB. Per exemple, la
possibilitat de comprovar si una clau existeix en un document
concret, consultar quin és el tipus del seu valor, o simplement
eliminar-la document.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="collecciopersones" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id3">[2]</a></td><td>Hem treballat amb la col·lecció <a class="reference external" href="../resources/persones02.json">persones</a> en articles anteriors.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="dadesficticies" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[3]</a></td><td>Les dades que apareixen a aquest fitxer són
fictícies. Si bé les adreces són reals (corresponen a ajuntaments
catalans), les dades de persones que tenen associades han estat
generades aleatòriament.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="ningushocreuaixo" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td>Recorda que aquests exercicis maneguen dades
fictícies.</td></tr>
</tbody>
</table>
</div>
</div>
</div>
<footer>
  <p>
  <a href="..">Apunts tècnics</a> 
  &copy; 
  <a href="http://www.gnu.org/copyleft/fdl.html">GNU FDL</a>
  per <i>Moisès Gómez Girón </i> (<img style="position:relative;top:+5px;border:0; display:inline;" src="../images/adressamoi.png">)
  amb el generador de blocs <a href="http://getpelican.com/">Pelican</a> 
  </p>
</footer>    </div>
</div>

</body>
</html>