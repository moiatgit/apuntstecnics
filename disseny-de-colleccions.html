<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Apunts tècnics: Disseny de col·leccions</title>
<meta name="description" content="">
<meta name="author" content="Moisès Gómez Girón">

<!-- HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
        <script src="./theme/html5.js"></script>
    <![endif]-->

<!-- Styles -->
<link href="./theme/bootstrap.moi.css" rel="stylesheet">
<link href="./theme/local.css" rel="stylesheet">
<link href="./theme/pygments.css" rel="stylesheet">

<!-- Feeds -->
<link href="http://apuntstecnics.herokuapp.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Apunts tècnics Atom Feed" />

</head>
<body>

<div class="topbar">
    <div class="topbar-inner">
        <div class="container-fluid">
            <a class="brand" href="./">[Apunts tècnics]
 Disseny de col·leccions             </a>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="sidebar">
        <div class="well">
            <!--
            <h3>Temes</h3>
                <ul>
                </ul>
            -->
            <h3>Categories</h3>
            <ul>
                <li class="active"><a href="./category/bd.html">bd</a></li>
                <li ><a href="./category/dev.html">dev</a></li>
                <li ><a href="./category/eines.html">eines</a></li>
                <li ><a href="./category/gui.html">gui</a></li>
                <li ><a href="./category/misc.html">misc</a></li>
                <li ><a href="./category/poo.html">poo</a></li>
                <li ><a href="./category/programacio.html">programacio</a></li>
                <li ><a href="./category/uml.html">uml</a></li>
            </ul>
            <h3>Tags</h3>
            <ul>
                <li><a href="./tag/c.html">C</a></li>
                <li><a href="./tag/postgresql.html">PostGreSQL</a></li>
                <li><a href="./tag/mongodb.html">mongoDB</a></li>
                <li><a href="./tag/programari.html">programari</a></li>
                <li><a href="./tag/util.html">util</a></li>
                <li><a href="./tag/java.html">java</a></li>
            </ul>
        </div>
    </div>

    <div class="content">
<div class='article'>
<div class="well small">
<ul id="navigation"> 
    <li class="navigation-prev">
    <a href="./arrays.html">
        Arrays
    </a>
    </li>

    <li class="navigation-top">
    <a href="./introduccio-al-mongodb.html">
        inici
    </a>
    </li>

</ul> 
</div>
    <div class="page-header"><h1>Disseny de col·leccions</h1></div>
<div class="well small">
    Entrada ubicada a la categoria
    <a href="./category/bd.html">
        bd
    </a>
            amb el tag:
            <a href="./tag/mongodb.html">mongoDB</a> 
</div>
    <div><div class="section" id="introduccio">
<h2>Introducció</h2>
<p>Als articles de <a class="reference external" href="./subdocuments.html">subdocuments</a> i d'<a class="reference external" href="./arrays.html">arrays</a> hem vist com, a MongoDB
disposem de valors complexos que en el model relacional sovint
s'acaben resolent amb múltiples taules.</p>
<p>Els exemples que hem treballat fins ara sempre han tingut present una
única col·lecció cada cop. MongoDB ara per ara <a class="footnote-reference" href="#finsara" id="id1">[1]</a> no ofereix
eines per a fer consultes entre col·leccions. Amb tot, sabem que es
poden crear múltiples col·leccions, i que aquestes es poden relacionar
entre si mitjançant els identificadors dels seus documents.  Si bé,
hem mantingut totes les dades relacionades a cada document dels
exemples anteriors, no és obligatori que sigui així.</p>
<p>Aquesta entrada pretén oferir-te uns elements de referència/reflexió
que t'ajudin a orientar-te. Trobaràs molta més profunditat a la
<a class="reference external" href="http://docs.mongodb.org/manual/core/data-modeling-introduction/">documentació oficial</a></p>
<p>Estudiarem aquest tema a partir de tres eixos: els subdocuments, els
arrays i, finalment, les cardinalitats de les relacions</p>
</div>
<div class="section" id="id2">
<h2>Subdocuments</h2>
<p>Recordem l'exemple de persona amb adreça que vam veure a l'article de
<a class="reference external" href="./subdocuments.html">subdocuments</a></p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;nom&quot;</span><span class="o">:</span>         <span class="s2">&quot;Jordi Navarro Cucurella&quot;</span><span class="p">,</span>
    <span class="s2">&quot;edat&quot;</span><span class="o">:</span>        <span class="mi">32</span><span class="p">,</span>
    <span class="s2">&quot;professió&quot;</span><span class="o">:</span>   <span class="s2">&quot;alcalde&quot;</span><span class="p">,</span>
    <span class="s2">&quot;sou&quot;</span><span class="o">:</span>         <span class="mi">320</span><span class="p">,</span>
    <span class="s2">&quot;adreça&quot;</span><span class="o">:</span>      <span class="p">{</span>
                        <span class="s2">&quot;carrer&quot;</span><span class="o">:</span>      <span class="s2">&quot;Únic S/N&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;població&quot;</span><span class="o">:</span>    <span class="s2">&quot;Berrós Jussà&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;cp&quot;</span><span class="o">:</span>          <span class="mi">25597</span><span class="p">,</span>
                        <span class="s2">&quot;localitat&quot;</span><span class="o">:</span>   <span class="s2">&quot;La Guingueta d&#39;Àneu&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;província&quot;</span><span class="o">:</span>   <span class="s2">&quot;Lleida&quot;</span>
                    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>En el model relacional, la incorporació de l'adreça es sol resoldre
amb alguna variació de les següents maneres:</p>
<ol class="arabic">
<li><p class="first">la <em>bruta</em>: afegint els camps de l'adreça directament a la taula de
persones. Les dades no queden normalitzades, és clar.</p>
</li>
<li><p class="first">la &quot;relacional&quot;: creant una taula d'adreces i relacionant les
entrades amb les persones a partir de la seva clau primària.</p>
</li>
<li><p class="first">Alguns SGBDs incorporen la característica de dades complexes del
model <a class="reference external" href="http://es.wikipedia.org/wiki/Base_de_datos_objeto-relacional">Objecte-Relacional</a>
(com ara PostGreSQL, Oracle DB entre d'altres)</p>
<p>En aquest cas, és possible fer servir quelcom molt similar al que
hem fet amb MongoDB.</p>
<p>Per exemple, en PostGreSQL definiríem el tipus <em>Adressa</em> segons:</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TYPE</span> <span class="n">Adressa</span> <span class="k">AS</span> <span class="p">(</span>
    <span class="n">carrer</span>     <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">poblacio</span>   <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">cp</span>         <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">localitat</span>  <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">provincia</span>  <span class="nb">TEXT</span>
<span class="p">);</span>
</pre></div>
<p>I faríem servir aquesta a la taula <em>persones</em> per exemple:</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">persones</span> <span class="p">(</span>
    <span class="n">id</span>         <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">nom</span>        <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">edat</span>       <span class="nb">SMALLINT</span><span class="p">,</span>
    <span class="n">professio</span>  <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">sou</span>        <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">adr</span>        <span class="n">Adressa</span>
<span class="p">);</span>
</pre></div>
</li>
</ol>
<p>Si ho mirem bé, l'adreça pot ser considerada un <em>tipus definit per
l'usuari</em> (<em>UDT</em> o <em>User Defined Type</em> en notació Objecte-Relacional).</p>
<p>Què passaria en comptes d'un tipus, estiguérem interessats en
representar la relació de dues entitats <em>com cal</em>. Per exemple, suposa
que tenim la típica relació <em>comades</em> i <em>línies de comanda</em> on cada
comanda pot tenir una o més línies de comanda i cada línia de comanda
correspon a un producte i la quantitat de producte demanada.</p>
<p>En el model relacional típicament representaríem aquesta relació de la
següent manera <a class="footnote-reference" href="#dersimplificat" id="id4">[2]</a>:</p>
<div class="figure align-center">
<img alt="Diagrama Entitat-Relació de COMANDES i LINIES_COMANDA" src="./images/mongodb.016.img001.DER.comandes.png" />
</div>
<p>Aquesta relació 1:N la resoldríem posant la clau primària de COMANDES
a LINIES_COMANDA <a class="footnote-reference" href="#references" id="id5">[4]</a>.</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">COMANDES</span> <span class="p">(</span>
    <span class="n">id</span>          <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="k">data</span>        <span class="nb">DATE</span><span class="p">,</span>
    <span class="n">client</span>      <span class="nb">TEXT</span><span class="p">,</span>
<span class="p">);</span>

<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">LINIES_COMANDA</span> <span class="p">(</span>
    <span class="n">id</span>          <span class="nb">INTEGER</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">id_comanda</span>  <span class="nb">INTEGER</span> <span class="k">REFERENCES</span> <span class="n">COMANDES</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="n">quantitat</span>   <span class="nb">REAL</span><span class="p">,</span>
    <span class="n">producte</span>    <span class="nb">TEXT</span>
<span class="p">);</span>
</pre></div>
<p>A MongoDB també podríem posar les comandes i les línies de comanda a
col·leccions separades, i afegir l'identificador de la comanda a cada
línia de comanda, tot calcant la representació del model relacional.
Amb tot, hauríem de trobar una bona excusa per fer-ho així. El més
probable és que les comandes es guardin en documents amb el següent
aspecte:</p>
<div class="highlight"><pre><span class="p">{</span>
    <span class="s2">&quot;_id&quot;</span> <span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;529a3f2b255c0122ce5280ba&quot;</span><span class="p">),</span>
    <span class="s2">&quot;data&quot;</span><span class="o">:</span> <span class="s2">&quot;2014/03/21&quot;</span><span class="p">,</span>
    <span class="s2">&quot;client&quot;</span><span class="o">:</span>  <span class="s2">&quot;Irene Ruíz Cloquell&quot;</span><span class="p">,</span>
    <span class="s2">&quot;línies&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;529a3f2b255c0122ce5280ba&quot;</span><span class="p">),</span>
            <span class="s2">&quot;quantitat&quot;</span><span class="o">:</span> <span class="mf">3.70</span><span class="p">,</span>
            <span class="s2">&quot;producte&quot;</span><span class="o">:</span> <span class="s2">&quot;Pollastre de corral qtat extra&quot;</span>
        <span class="p">},</span>
        <span class="p">{</span>
            <span class="s2">&quot;_id&quot;</span><span class="o">:</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&quot;529f60032cb934f132280b25&quot;</span><span class="p">),</span>
            <span class="s2">&quot;quantitat&quot;</span><span class="o">:</span> <span class="mf">4.23</span><span class="p">,</span>
            <span class="s2">&quot;producte&quot;</span><span class="o">:</span> <span class="s2">&quot;Salsitxes casolanes gall dindi&quot;</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="section" id="id6">
<h2>Arrays</h2>
<p>Acabem de veure a l'exemple de comandes de la secció anterior, com
podem resoldre la incorporació de més d'una línia a una comanda a
MongoDB.</p>
<p>En el model relacional, a l'igual que amb els subdocuments, la
incorporació de llistes també es sol realitzar amb alguna variació de
les següents maneres:</p>
<ol class="arabic">
<li><p class="first">la <em>bruta</em>: afegint uns tants camps com el màxim que esperem
guardar-hi. Per exemple, si hem de posar els telèfons d'una
persona, faríem quelcom similar a:</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">persones</span> <span class="p">(</span>
    <span class="n">id</span>         <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">nom</span>        <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">edat</span>       <span class="nb">SMALLINT</span><span class="p">,</span>
    <span class="n">professio</span>  <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">sou</span>        <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">telefon1</span>   <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">telefon2</span>   <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">telefon3</span>   <span class="nb">TEXT</span>
<span class="p">);</span>
</pre></div>
</li>
<li><p class="first">la <em>relacional</em>: creant una taula amb els telèfons i associant-los
la persona</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">Telefons</span> <span class="p">(</span>
    <span class="n">id</span>         <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">id_persona</span> <span class="nb">INTEGER</span> <span class="k">REFERENCES</span> <span class="n">Persones</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="n">numero</span>     <span class="nb">TEXT</span>
<span class="p">);</span>
</pre></div>
</li>
<li><p class="first">la <em>objecte-relacional</em>: aquells SGBDs que admeten característiques
objecte-relacionals, sovint ofereixen suport pels arrays.</p>
<p>Per exemple, en PostGreSQL, definiríem:</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">persones</span> <span class="p">(</span>
    <span class="n">id</span>         <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">nom</span>        <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">edat</span>       <span class="nb">SMALLINT</span><span class="p">,</span>
    <span class="n">professio</span>  <span class="nb">TEXT</span><span class="p">,</span>
    <span class="n">sou</span>        <span class="nb">INTEGER</span><span class="p">,</span>
    <span class="n">telefons</span>   <span class="nb">TEXT</span><span class="p">[]</span>
<span class="p">);</span>
</pre></div>
<p>PostGreSQL permet definir arrays tot indicant els claudàtors al
final, de manera molt similar a la es fa servir en llenguatges de
programació com ara Java. Fins i tot es poden afegir tipus definits
per nosaltres (UDT) com ara l'adreça.</p>
</li>
</ol>
<p>A MongoDB, com ja hem pogut veure a diferents exemples, adoptem una
solució idèntica (si no ens fixem en la sintaxi) a la que ens ofereix
PostGreSQL.</p>
</div>
<div class="section" id="cardinalitat-de-les-relacions">
<h2>Cardinalitat de les relacions</h2>
<p>Així què? Fem servir una o dues col·leccions per emmagatzemar dades
relacionades?</p>
<p>En general, tendirem a preferir guardar en la mateixa col·lecció les
dades que sovint voldrem consultar juntes. És a dir, no ens
preocuparem de <em>normalitzar</em> les dades com al model relacional.</p>
<p>Com a guia per decidir-te si fer servir una o dues col·leccions per
representar una relació entre dues entitats amb MongoDB, considera:</p>
<ul>
<li><p class="first">relacions <em>1:1</em> : En general farem servir una única col·lecció, a
menys que ens interessi separar-les per alguna raó. Per exemple,
perquè ocupen massa juntes <a class="footnote-reference" href="#maxim16mb" id="id7">[3]</a></p>
</li>
<li><p class="first">relacions <em>1:N</em> : Normalment ho ficarem tot a una col·lecció si <em>N</em>
és <em>petita</em>. Per exemple, hi ha relativament poques línies de
comandes per cada comanda.
Imagina, però, que tens la llista d'habitants de Catalunya per
comarca. En aquest cas <em>N</em> pot arribar a ser una mica gran en alguns
casos, i potser voldràs separar les col·leccions <em>comarques</em> i
<em>habitants</em>.</p>
</li>
<li><p class="first">relacions <em>M:N</em> : En aquest cas, ens podem plantejar si dupliquem la
informació o bé fem servir dues col·leccions amb llistes
d'identificadors a una o a les dues entitats.</p>
<p>Si bé és cert la majoria de les vegades fa por duplicar informació
per problemes de coherència, hi ha aplicacions per les quals, no és
tan problemàtic que les dades puguin patir de certa incoherència i,
en canvi, és molt més prioritari l'agilitat d'accés a les dades. Per
exemple, considera els comentaris a les entrades d'un bloc.
Probablement et podria agradar tenir una col·lecció de
<em>comentaristes</em> separada de la d'<em>entrades</em>. Així, si un
comentarista canvia de correu electrònic, el canvi es podria veure
reflectit en tots els seus comentaris. El més probable, però, és que
no t'importi tant si en algunes entrades el comentarista ha fet
servir un pseudònim o un altre.</p>
</li>
</ul>
<p>En resum, el model documental no valora de la mateixa manera que el
relacional la normalització de les dades. La seva prioritat, sovint,
es troba més en l'agilitat d'accés. Per tot plegat, és fàcil trobar-se
amb documents <em>complexos</em> on apareixen les dades de diferents entitats
relacionades entre si.</p>
<div class="section" id="exercici-1-entrades-d-un-bloc">
<h3>Exercici 1. Entrades d'un bloc</h3>
<p>Una entrada en un bloc té un autor, una data, un títol i un
desenvolupament (bàsicament el text de l'entrada). Cada entrada pot
tenir 0 o més comentaris. Un comentari té un autor (el comentarista),
una data, una adreça de correu, i un text amb el comentari.</p>
<p>Proposa un diagrama E/R o bé la implementació en SQL de les entitats i
relacions d'aquest enunciat. Pista: entrades, autors, comentaris.</p>
<p>Proposa una implementació amb MongoDB tot tenint en compte les
reflexions anteriors.</p>
<p><strong>Pista</strong>: inventat les dades (és clar) i no cal ni que arribis al <em>lorem
ipsum</em> pel text (amb un <em>text de l'entrada</em> n'hi hauria prou)</p>
</div>
<div class="section" id="exercici-2-ampliacio-comandes-ampliades">
<h3>Exercici 2. (ampliació) Comandes ampliades</h3>
<p>Plantejat el model COMANDES i LINIES_COMANDA vist abans. Aquest cop,
però, l'ampliarem amb les entitats CLIENTS i PRODUCTES.</p>
<p>Dels clients en guardarem el NIF, el nom de contacte, l'adreça de
facturació i la d'enviament, i un o més telèfons.</p>
<p>Dels productes guardarem el nom, una descripció i el preu unitari.</p>
<p>Fes una proposta en model relacional i, més important, una per
MongoDB. Com sempre, inventat les dades però fes que semblin
realistes.</p>
</div>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<table class="docutils footnote" frame="void" id="finsara" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>Això és cert en el moment en que escric aquests
articles. Potser en un futur la cosa canviï.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="dersimplificat" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[2]</a></td><td>Es tracta d'una versió simplificada. Entre
d'altres coses, probablement, a una implementació més realista, els
clients i els productes tindrien les seves pròpies taules.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="maxim16mb" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id7">[3]</a></td><td>Recorda que hi ha un límit de 16Mb com a màxim per
document a MongoDB.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="references" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[4]</a></td><td>En altres SGBDs diferents de PostGreSQL, <em>REFERENCES</em>
equival a <em>FOREIGN KEY</em>.</td></tr>
</tbody>
</table>
</div>
</div>
<div class="well small">
<ul id="navigation"> 
    <li class="navigation-prev">
    <a href="./arrays.html">
        Arrays
    </a>
    </li>

    <li class="navigation-top">
    <a href="./introduccio-al-mongodb.html">
        inici
    </a>
    </li>

</ul> 
</div>
</div>
<footer>
  <p>
  <a href=".">Apunts tècnics</a> 
  &copy; 
  <a href="http://www.gnu.org/copyleft/fdl.html">GNU FDL</a>
  per <i>Moisès Gómez Girón </i> (<img style="position:relative;top:+5px;border:0; display:inline;" src="./images/adressamoi.png">)
  amb el generador de blocs <a href="http://getpelican.com/">Pelican</a> 
  </p>
</footer>    </div>
</div>

</body>
</html>