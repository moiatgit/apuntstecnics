<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Apunts tècnics: JDBC III. Model Objecte-Relacional</title>
<meta name="description" content="">
<meta name="author" content="Moisès Gómez Girón">

<!-- HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
        <script src="./theme/html5.js"></script>
    <![endif]-->

<!-- Styles -->
<link href="./theme/bootstrap.moi.css" rel="stylesheet">
<link href="./theme/local.css" rel="stylesheet">
<link href="./theme/pygments.css" rel="stylesheet">

<!-- Feeds -->
<link href="http://apuntstecnics.herokuapp.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Apunts tècnics Atom Feed" />

</head>
<body>

<div class="topbar">
    <div class="topbar-inner">
        <div class="container-fluid">
            <a class="brand" href="./">[Apunts tècnics]
 JDBC III. Model Objecte-Relacional             </a>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="sidebar">
        <div class="well">
            <!--
            <h3>Temes</h3>
                <ul>
                </ul>
            -->
            <h3>Categories</h3>
            <ul>
                <li class="active"><a href="./category/bd.html">bd</a></li>
                <li ><a href="./category/dev.html">dev</a></li>
                <li ><a href="./category/eines.html">eines</a></li>
                <li ><a href="./category/misc.html">misc</a></li>
                <li ><a href="./category/mongodb.html">mongodb</a></li>
                <li ><a href="./category/poo.html">poo</a></li>
                <li ><a href="./category/programacio.html">programacio</a></li>
                <li ><a href="./category/uml.html">uml</a></li>
            </ul>
            <h3>Tags</h3>
            <ul>
                <li><a href="./tag/c.html">C</a></li>
                <li><a href="./tag/jdbc.html">JDBC</a></li>
                <li><a href="./tag/postgresql.html">PostGreSQL</a></li>
                <li><a href="./tag/mongodb.html">mongoDB</a></li>
                <li><a href="./tag/programari.html">programari</a></li>
                <li><a href="./tag/util.html">util</a></li>
                <li><a href="./tag/test.html">test</a></li>
                <li><a href="./tag/java.html">java</a></li>
            </ul>
        </div>
    </div>

    <div class="content">
<div class='article'>
<div class="well small">
<ul id="navigation"> 
    <li class="navigation-prev">
    <a href="./jdbc-ii-model-relacional.html">
        JDBC II. Model relacional
    </a>
    </li>

    <li class="navigation-top">
    <a href="./jdbc-i-introduccio-al-jdbc.html">
        inici
    </a>
    </li>

</ul> 
</div>
    <div class="page-header"><h1>JDBC III. Model Objecte-Relacional</h1></div>
<div class="well small">
    Entrada ubicada a la categoria
    <a href="./category/bd.html">
        bd
    </a>
            amb els tags: 
            <a href="./tag/postgresql.html">PostGreSQL</a> 
            <a href="./tag/java.html">java</a> 
</div>
    <div><div class="section" id="introducio">
<h2>Introdució</h2>
<p>Amb aquests continguts treballarem la manera de comunicar els nostres
programes orientats a objecte amb les nostres bases de dades objecte
relacionals.</p>
<p>A aquesta darrera part es considera com podem fer servir el JDBC per
comunicar-nos amb una base de dades que implementi elements
d'Objecte-Relacional.</p>
<p>Els continguts pressuposen que disposes de la base de dades presentada
als <a class="reference external" href="./comparacio-models-relacional-i-objecte-relacionals-segona-part.html">continguts sobre el model objecte relacional</a>. Es realitzarà
uns <em>lleugers</em> canvis que es descriuen a diferents exercicis.</p>
</div>
<div class="section" id="jdbc-sobre-sgbdor">
<h2>JDBC sobre SGBDOR</h2>
<p>El mecanisme per guardar instàncies d'objectes a una
base de dades relacional, el descriuen alguns a partir del següent
símil:</p>
<blockquote>
Imagina que per aparcar cada nit el teu cotxe al garatge, en
passar per la porta l'haguessis de desmuntar peça a peça i
guardar-les convenientment en diferents calaixos especialment
destinats per cadascuna d'aquestes. Tot plegat, per l'endemà haver
de tornar a muntar tot el vehicle de nou a partir de les peces si
el vols tornar a conduir.</blockquote>
<p>Malauradament en l'actualitat, amb les bases de dades
Objecte-Relacional la situació no ha millorat gaire. Hom diria que
fins i tot ha empitjorat. De fet, jugant amb el símil del cotxe:</p>
<blockquote>
Imagina que per aparcar cada nit el teu cotxe al garatge, en
passar per la porta l'haguessis de desmuntar peça a peça,
tornar-les a muntar en diferents blocs i guardar aquests
convenientment en diferents calaixos especialment destinats per
cadascun d'aquests. Tot plegat, per l'endemà haver de tornar a
desmuntar els blocs i, ja fora del garatge, tornar a muntar tot el
vehicle de nou a partir de les peces si el vols tornar a conduir.</blockquote>
<p>S'estan fent diferents esforços per estalviar-nos als desenvolupadors
la feixuga tasca de muntatge i desmuntatge dels nostres objectes i
entitats. Considera per exemple <a class="reference external" href="http://ca.wikipedia.org/wiki/Hibernate">Hibernate</a>. Amb tot, encara molts
desenvolupaments es realitzen <em>a ma</em>. En el nostre cas, estem obligats
a fer-ho manualment, ja que les funcionalitats objecte-relacional que
encara no disposen de prou suport.</p>
<p>En el moment en que escric aquest document, el JDBC per
PostGreSQL no es troba completament implementat (especialment per la
part que toca a les funcionalitats Objecte-Relacionals). Per aquesta
raó, ens haurem de mantenir en un nivell encara més <em>manual</em> del que
ens ofereix la definició del JDBC.</p>
<div class="section" id="implementacio-d-un-enumerat">
<h3>Implementació d'un enumerat</h3>
<p>Els enumerats de PostGreSQL es corresponen molt còmodament amb els
enumerats de Java.</p>
<p>Per exemple, <em>Tractament</em> es podria implementar com:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">enum</span> <span class="n">Tractament</span> <span class="o">{</span>
    <span class="n">SR</span>   <span class="o">(</span> <span class="s">&quot;Sr.&quot;</span>   <span class="o">),</span>
    <span class="n">SRA</span>  <span class="o">(</span> <span class="s">&quot;Sra.&quot;</span>  <span class="o">),</span>
    <span class="n">SRTA</span> <span class="o">(</span> <span class="s">&quot;Srta.&quot;</span> <span class="o">),</span>
    <span class="n">DR</span>   <span class="o">(</span> <span class="s">&quot;Dr.&quot;</span>   <span class="o">),</span>
    <span class="n">DRA</span>  <span class="o">(</span> <span class="s">&quot;Dra.&quot;</span>  <span class="o">);</span>

    <span class="kd">private</span> <span class="n">String</span> <span class="n">representacio</span><span class="o">;</span>

    <span class="n">Tractament</span><span class="o">(</span><span class="n">String</span> <span class="n">rep</span><span class="o">)</span> <span class="o">{</span> <span class="n">representacio</span> <span class="o">=</span> <span class="n">rep</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">representacio</span><span class="o">;</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="n">Tractament</span> <span class="nf">fromString</span><span class="o">(</span><span class="n">String</span> <span class="n">rep</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Tractament</span> <span class="n">trobat</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">Tractament</span> <span class="n">e</span><span class="o">:</span> <span class="n">values</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="n">rep</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">trobat</span> <span class="o">=</span> <span class="n">e</span><span class="o">;</span>
                <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">trobat</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">IllegalArgumentException</span><span class="o">(</span><span class="s">&quot;No enum constant Tractament.&quot;</span><span class="o">+</span><span class="n">rep</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">trobat</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Fixa't que aquest enumerat ofereix el mètode <em>fromString()</em> que,
donada una representació en forma de String, retorna el valor
corresponent de l'enumerat.</p>
</div>
<div class="section" id="exercici-1-modificacio-del-model-de-dades">
<h3>Exercici 1. Modificació del model de dades</h3>
<p>Realitza les següents modificacions al model de dades:</p>
<ul class="simple">
<li>en la definició de les claus primàries de les diferents taules
passaran a ser <em>SERIAL</em>. D'aquesta manera no caldrà que ens
preocupem de gestionar els identificadors.</li>
<li>les entitats CLIENTS i COMERCIALS disposaran d'un nou camp (nif) que
no podrà ser nul ni repetit.</li>
</ul>
</div>
<div class="section" id="exercici-2-el-tipustelefon">
<h3>Exercici 2. El TipusTelefon</h3>
<p>A partir de l'exemple de l'enumerat <em>Tractament</em> implementa un
enumerat que correspongui al <em>TipusTelefon</em>.</p>
</div>
<div class="section" id="implementacio-d-un-tipus-complex">
<h3>Implementació d'un tipus complex</h3>
<p>Considera la següent implementació de la classe <em>Denominacio</em>. Fixa't
en com permet crear una denominació a partir d'un tractament en format
<em>String</em> com requeria el codi de <tt class="docutils literal">parseDenominacio()</tt> que hem vist
abans.</p>
<div class="highlight"><pre><span class="kd">class</span> <span class="nc">Denominacio</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Tractament</span> <span class="n">tr</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nom</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">cognoms</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Denominacio</span><span class="o">(</span><span class="n">String</span> <span class="n">tr</span><span class="o">,</span> <span class="n">String</span> <span class="n">nom</span><span class="o">,</span> <span class="n">String</span> <span class="n">cognoms</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(</span><span class="n">Tractament</span><span class="o">.</span><span class="na">fromString</span><span class="o">(</span><span class="n">tr</span><span class="o">),</span> <span class="n">nom</span><span class="o">,</span> <span class="n">cognoms</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">Denominacio</span><span class="o">(</span><span class="n">Tractament</span> <span class="n">tr</span><span class="o">,</span> <span class="n">String</span> <span class="n">nom</span><span class="o">,</span> <span class="n">String</span> <span class="n">cognoms</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">tr</span><span class="o">=</span><span class="n">tr</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">nom</span><span class="o">=</span><span class="n">nom</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">cognoms</span><span class="o">=</span><span class="n">cognoms</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Tractament</span> <span class="nf">getTr</span><span class="o">()</span>  <span class="o">{</span> <span class="k">return</span> <span class="n">tr</span><span class="o">;</span>      <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getNom</span><span class="o">()</span>     <span class="o">{</span> <span class="k">return</span> <span class="n">nom</span><span class="o">;</span>     <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCognoms</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">cognoms</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span>   <span class="o">{</span> <span class="k">return</span> <span class="n">tr</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">nom</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">cognoms</span><span class="o">;</span> <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Com podem observar, un tipus complex es tradueix directament a una
classe estàndard de Java. Es tracta, això sí, d'una classe sovint
immutable (com en aquest cas), i que pràcticament no ofereix res més
que l'accés al valor de les seves propietats.</p>
<p>Fixa't que aquesta classe ofereix dos constructors. El primer accepta
el tractament en forma de String. Més endavant es veurà que ens
resultarà molt còmode.</p>
</div>
<div class="section" id="exercici-3-telefon">
<h3>Exercici 3. Telèfon</h3>
<p>Implementa el tipus <em>Telefon</em> seguint la idea de la classe
<em>Denominacio</em>.</p>
</div>
<div class="section" id="acces-directe-a-un-camp-complex">
<h3>Accés directe a un camp complex</h3>
<p>Veiem com podem accedir a un camp complex.</p>
<p>Suposa que a la base de dades disposem de</p>
<div class="highlight"><pre><span class="n">testbd</span><span class="o">=&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">clients</span> <span class="k">where</span> <span class="n">id</span> <span class="o">=</span> <span class="mi">20001</span><span class="p">;</span>
  <span class="n">id</span>   <span class="o">|</span>          <span class="n">nom</span>          <span class="o">|</span>                                        <span class="n">adr</span>                                        <span class="o">|</span>                    <span class="n">telefons</span>
<span class="c1">-------+-----------------------+-----------------------------------------------------------------------------------+-------------------------------------------------</span>
 <span class="mi">20001</span> <span class="o">|</span> <span class="p">(</span><span class="n">Sra</span><span class="p">.,</span><span class="n">Barbara</span><span class="p">,</span><span class="n">Liskov</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="ss">&quot;{&quot;&quot;77 Massachusetts Avenue&quot;&quot;,&quot;&quot;Blue Bilding&quot;&quot;}&quot;</span><span class="p">,</span><span class="ss">&quot;MA 02139-4307&quot;</span><span class="p">,</span><span class="n">Cambridge</span><span class="p">,</span><span class="n">EEUU</span><span class="p">)</span> <span class="o">|</span> <span class="err">{</span><span class="ss">&quot;(fax,0084,933333333)&quot;</span><span class="p">,</span><span class="ss">&quot;(fix,0084,933333334)&quot;</span><span class="err">}</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</pre></div>
<p>Considera el següent fragment de codi que llegeix la denominació d'un
client a partir del seu identificador</p>
<div class="highlight"><pre><span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;SELECT nom FROM CLIENTS WHERE id =&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
<span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
<span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
<span class="n">String</span> <span class="n">nom</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;nom&quot;</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;nom: &quot;</span> <span class="o">+</span> <span class="n">nom</span><span class="o">);</span>
</pre></div>
<p>Si executem aquest codi ens generarà el següent resultat</p>
<pre class="literal-block">
nom: (Sra.,Barbara,Liskov)
</pre>
<p>Es a dir, ens ha generat tots els continguts d'un tipus compost en un
string!</p>
</div>
<div class="section" id="camps-complexos-desmuntats">
<h3>Camps complexos <em>desmuntats</em></h3>
<p>Amb les dades d'un camp complex codificades en forma de tupla, i el
<em>driver</em> de PostGreSQL a mig fer <a class="footnote-reference" href="#suportstruct" id="id1">[1]</a>, ens veiem obligats
a idear algun <em>truc</em> per extreure la informació.</p>
<p>Una possibilitat és demanar les dades ja <em>desmuntades</em> al SGBD</p>
<div class="highlight"><pre><span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;SELECT (nom).* FROM CLIENTS WHERE id =&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
<span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
<span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
<span class="n">String</span> <span class="n">tr</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;tr&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">nom</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;nom&quot;</span><span class="o">);</span>
<span class="n">String</span> <span class="n">cognoms</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;cognoms&quot;</span><span class="o">);</span>
<span class="n">Denominacio</span> <span class="n">denom</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Denominacio</span><span class="o">(</span><span class="n">tr</span><span class="o">,</span> <span class="n">nom</span><span class="o">,</span> <span class="n">cognoms</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;nom: &quot;</span> <span class="o">+</span> <span class="n">denom</span><span class="o">);</span>
</pre></div>
<p>Ara la sortida (suposant codificada adequadament la classe
<em>Denominacio</em>) serà:</p>
<pre class="literal-block">
nom: Sra. Barbara Liskov
</pre>
</div>
<div class="section" id="camps-complexos-parsejats">
<h3>Camps complexos <em>parsejats</em></h3>
<p>De vegades pot no ser convenient (o fàcil) aconseguir una comanda sql
que ens retorni les dades compostes <em>desmuntades</em>.</p>
<p>Una altra alternativa és que ens fem nosaltres el nostre <em>parser</em>.</p>
<p>Per exemple, considera el següent mètode per la classe <em>Denominacio</em></p>
<div class="highlight"><pre><span class="cm">/* retorna una denominació a partir d&#39;una tupla &quot;(tr,nom,cognoms)&quot;</span>
<span class="cm"> * codificada a un String.</span>
<span class="cm"> * En cas que no sigui una tupla vàlida retorna null. */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Denominacio</span> <span class="nf">parseDenominacio</span><span class="o">(</span><span class="n">String</span> <span class="n">tupla</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Denominacio</span> <span class="n">denom</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">tupla</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;(&quot;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">tupla</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;)&quot;</span><span class="o">))</span> <span class="o">{</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">tupla</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">tupla</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">1</span><span class="o">).</span><span class="na">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">elements</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">denom</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Denominacio</span><span class="o">(</span><span class="n">elements</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="n">elements</span><span class="o">[</span><span class="mi">1</span><span class="o">],</span> <span class="n">elements</span><span class="o">[</span><span class="mi">2</span><span class="o">]);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">denom</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>Disposant d'aquest senzill <em>parser</em> podrem aconseguir la denominació
simplement amb:</p>
<div class="highlight"><pre><span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;SELECT nom FROM CLIENTS WHERE id =&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
<span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
<span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
<span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
<span class="n">String</span> <span class="n">tupla</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;nom&quot;</span><span class="o">);</span>
<span class="n">Denominacio</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">parseDenominacio</span><span class="o">(</span><span class="n">tupla</span><span class="o">);</span>
<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;nom: &quot;</span> <span class="o">+</span> <span class="n">denom</span><span class="o">);</span>
</pre></div>
<p>Cal tenir en compte que aquest <em>parser</em> no ens servirà en tots els
casos. Per exemple, si la senyora Liskov tingués dos cognoms (com ara
'Liskov d'Argent', el resultat seria que PostGreSQL ens retornaria els
dos cognoms entre cometes dobles. Un cas pitjor apareix si pel que
sigui, els cognoms contenen una coma. El nostre <em>parser</em> detectaria
més dels tres camps que espera i retornaria <em>null</em>!</p>
<p>La següent versió està preparada per tuples tan particulars com
<tt class="docutils literal">(Sra.&nbsp; &quot;Barbara Maria&quot;, &quot;Liskov, <span class="pre">&quot;&quot;d'Argent&quot;&quot;)</span></tt>. Probablement en
tindrem més que suficient pels exercicis que treballarem en aquest
document. Fa servir una <a class="reference external" href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html">expressió regular</a>,
per extreure cada element <a class="footnote-reference" href="#regexsimple" id="id2">[2]</a>.</p>
<div class="highlight"><pre><span class="cm">/* donada una seqüència de valors tancats entre parèntesis o claus</span>
<span class="cm"> * separats per comes i amb possibilitat d&#39;estar envoltats per cometes</span>
<span class="cm"> * dobles que a l&#39;hora puguin incloure dobles cometes dobles &quot;&quot; i comes,</span>
<span class="cm"> * retorna la llista de strings.*/</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="nf">splitSeq</span><span class="o">(</span><span class="n">String</span> <span class="n">seq</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">// patró per extreure els elements</span>
    <span class="n">Pattern</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">Pattern</span><span class="o">.</span><span class="na">compile</span><span class="o">(</span><span class="s">&quot;((\&quot;((\&quot;\&quot;)|([^\&quot;]))*\&quot;)|([^\&quot;,]*)),&quot;</span><span class="o">);</span>
    <span class="cm">/* elimina els parèntesis que envolten la seqüència */</span>
    <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">((</span><span class="n">seq</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;(&quot;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">seq</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;)&quot;</span><span class="o">))</span> <span class="o">||</span>
            <span class="o">(</span><span class="n">seq</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;{&quot;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">seq</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">&quot;}&quot;</span><span class="o">)))</span> <span class="o">{</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">seq</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">seq</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">1</span><span class="o">));</span>
            <span class="o">}</span>
    <span class="cm">/* afegeix una coma al final per permetre una regex simple */</span>
    <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">);</span>
    <span class="cm">/* realitza el parseig */</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">trobats</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;();</span>
    <span class="n">Matcher</span> <span class="n">matcher</span> <span class="o">=</span> <span class="n">pattern</span><span class="o">.</span><span class="na">matcher</span><span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">());</span>
    <span class="k">while</span> <span class="o">(</span><span class="n">matcher</span><span class="o">.</span><span class="na">find</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">element</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">element</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">element</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">element</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;\&quot;&quot;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span> <span class="n">element</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;\&quot;\&quot;&quot;</span><span class="o">))</span> <span class="o">{</span>
                <span class="c1">// elimina cometes a l&#39;inici i final</span>
                <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">element</span><span class="o">.</span><span class="na">length</span><span class="o">()-</span><span class="mi">1</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="c1">// simplifica cometes dobles</span>
            <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">&quot;\&quot;\&quot;&quot;</span><span class="o">,</span><span class="s">&quot;\&quot;&quot;</span><span class="o">);</span>
            <span class="c1">// afegeix l&#39;element un cop &quot;netejat&quot;</span>
            <span class="n">trobats</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">element</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">trobats</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>Fixa't que ara, implementar el mètode <em>parseDenominacio()</em> és molt
senzill:</p>
<div class="highlight"><pre><span class="cm">/* retorna una denominació a partir d&#39;una tupla &quot;(tr,nom,cognoms)&quot;</span>
<span class="cm"> * codificada a un String.</span>
<span class="cm"> * En cas que no sigui una tupla vàlida retorna null. */</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="n">Denominacio</span> <span class="nf">parseDenominacio</span><span class="o">(</span><span class="n">String</span> <span class="n">tupla</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Denominacio</span> <span class="n">denom</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">trobats</span> <span class="o">=</span> <span class="n">splitSeq</span><span class="o">(</span><span class="n">tupla</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">trobats</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">3</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">denom</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Denominacio</span><span class="o">(</span><span class="n">trobats</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span> <span class="n">trobats</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">trobats</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">denom</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="exercici-4-parsetelefon">
<h3>Exercici 4. parseTelefon()</h3>
<p>Seguint l'exemple de codi del mètode <em>parseDenominacio()</em> implementa
el mètode <em>parseTelefon()</em>.</p>
<p>Col·loca tots dos mètodes a una nova classe que es digui
<em>VendesParser</em> que ens permetrà agrupar aquests mètodes d'utilitat en
un únic lloc <a class="footnote-reference" href="#principispooalterra" id="id3">[4]</a>.</p>
<p><strong>Nota</strong>: Si tens intenció de realitzar exercicis de prova unitària,
potser voldràs mirar-te primer l'exercici següent i començar per la
prova.</p>
</div>
<div class="section" id="exercici-5-test-de-parsers">
<h3>Exercici 5. ★ Test de parsers</h3>
<p>Desenvolupa un codi de test pels dos mètodes <em>parser</em>.</p>
<p>Hi pots testar que els dos mètodes retornin una denominació / un
telèfon correctes a partir de tuples controlades pel test.</p>
<p>Es tracta d'un test senzill que et permetrà <em>escalfar motors</em>.</p>
</div>
<div class="section" id="arrays">
<h3>Arrays</h3>
<p>Veiem com podem tractar elements de tipus <em>array</em>.</p>
<p>Recordem la definició del tipus <em>Adressa</em></p>
<div class="highlight"><pre><span class="n">testbd</span><span class="o">=&gt;</span> <span class="err">\</span><span class="n">d</span> <span class="n">adressa</span>
         <span class="n">Composite</span> <span class="k">type</span> <span class="ss">&quot;public.adressa&quot;</span>
   <span class="k">Column</span>    <span class="o">|</span>         <span class="k">Type</span>          <span class="o">|</span> <span class="n">Modifiers</span>
<span class="c1">-------------+-----------------------+-----------</span>
 <span class="n">carrer</span>      <span class="o">|</span> <span class="nb">text</span><span class="p">[]</span>                <span class="o">|</span>
 <span class="n">codi_postal</span> <span class="o">|</span> <span class="nb">character</span> <span class="nb">varying</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">|</span>
 <span class="n">ciutat</span>      <span class="o">|</span> <span class="nb">text</span>                  <span class="o">|</span>
 <span class="n">pais</span>        <span class="o">|</span> <span class="nb">text</span>                  <span class="o">|</span>
</pre></div>
<p>Com podem veure, <em>carrer</em> apareix definit com a <em>array</em> de <em>strings</em>.</p>
<p>La representació del tipus <em>Adressa</em> en Java pot tenir un aspecte similar
al següent</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Adressa</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">String</span><span class="o">[]</span> <span class="n">carrer</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span>   <span class="n">codiPostal</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span>   <span class="n">ciutat</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span>   <span class="n">pais</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Adressa</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">carrer</span><span class="o">,</span> <span class="n">String</span> <span class="n">codiPostal</span><span class="o">,</span> <span class="n">String</span> <span class="n">ciutat</span><span class="o">,</span> <span class="n">String</span> <span class="n">pais</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">carrer</span>      <span class="o">=</span> <span class="n">carrer</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">codiPostal</span>  <span class="o">=</span> <span class="n">codiPostal</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">ciutat</span>      <span class="o">=</span> <span class="n">ciutat</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">pais</span>        <span class="o">=</span> <span class="n">pais</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span><span class="o">[]</span> <span class="nf">getCarrer</span><span class="o">()</span>    <span class="o">{</span> <span class="k">return</span> <span class="n">carrer</span><span class="o">;</span> <span class="o">}</span>
    <span class="err">«</span><span class="o">...</span><span class="err">»</span>
<span class="o">}</span>
</pre></div>
<p>Així, construirem una adreça amb</p>
<div class="highlight"><pre><span class="n">String</span><span class="o">[]</span> <span class="n">liniesCarrer</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;C/Antracita, 21&quot;</span><span class="o">,</span> <span class="s">&quot;Pol. Ind. Gualda&quot;</span><span class="o">};</span>
<span class="n">Adressa</span> <span class="n">adr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Adressa</span><span class="o">(</span><span class="n">liniesCarrer</span><span class="o">,</span> <span class="s">&quot;08020&quot;</span><span class="o">,</span> <span class="s">&quot;Barcelona&quot;</span><span class="o">,</span> <span class="s">&quot;Catalunya&quot;</span><span class="o">);</span>
</pre></div>
<p>Recordem que en SQL, l'aspecte que ha de tenir aquesta adreça segons
la definició a la base de dades és:</p>
<div class="highlight"><pre><span class="k">ROW</span><span class="p">(</span><span class="nb">ARRAY</span><span class="p">[</span><span class="s1">&#39;C/Antracita, 21&#39;</span><span class="p">,</span><span class="s1">&#39;Pol. Ind. Gualda&#39;</span><span class="p">],</span><span class="s1">&#39;08020&#39;</span><span class="p">,</span><span class="s1">&#39;Barcelona&#39;</span><span class="p">,</span><span class="s1">&#39;Catalunya&#39;</span><span class="p">)</span>
</pre></div>
<p>Podem composar aquests valors amb els següents mètodes</p>
<div class="highlight"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">composaCarrer</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">linies</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">String</span> <span class="n">carrer</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">linies</span><span class="o">.</span><span class="na">length</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">carrer</span> <span class="o">=</span> <span class="s">&quot;ARRAY[]&quot;</span><span class="o">;</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">StringBuilder</span> <span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">(</span><span class="s">&quot;ARRAY[&#39;&quot;</span><span class="o">);</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">linies</span><span class="o">[</span><span class="mi">0</span><span class="o">]);</span>
        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">linies</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;&#39;,&#39;&quot;</span><span class="o">);</span>
            <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">linies</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
        <span class="o">}</span>
        <span class="n">sb</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;&#39;]&quot;</span><span class="o">);</span>
        <span class="n">carrer</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">carrer</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">composaAdressa</span><span class="o">(</span><span class="n">Adressa</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;ROW(%s,&#39;%s&#39;,&#39;%s&#39;,&#39;%s&#39;)&quot;</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">carrer</span> <span class="o">=</span> <span class="n">composaCarrer</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="na">getCarrer</span><span class="o">());</span>
    <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span><span class="n">carrer</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="na">getCodiPostal</span><span class="o">(),</span> <span class="n">a</span><span class="o">.</span><span class="na">getCiutat</span><span class="o">(),</span> <span class="n">a</span><span class="o">.</span><span class="na">getPais</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
<p>A l'hora de llegir l'adreça, ens trobem que ens retorna la següent
tupla:</p>
<div class="highlight"><pre><span class="p">(</span><span class="ss">&quot;{&quot;&quot;C/Antracita, 21&quot;&quot;,&quot;&quot;Pol. Ind. Gualda&quot;&quot;}&quot;</span><span class="p">,</span><span class="mi">08020</span><span class="p">,</span><span class="n">Barcelona</span><span class="p">,</span><span class="n">Catalunya</span><span class="p">)</span>
</pre></div>
<p>Per interpretar-la, ho tenim molt fàcil gràcies al mètode <em>splitSeq()</em>
que hem presentat abans. Així el següent mètode ens pot construir una
adreça a partir de la tupla anterior</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="n">Adressa</span> <span class="nf">parseAdressa</span><span class="o">(</span><span class="n">String</span> <span class="n">tupla</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Adressa</span> <span class="n">adr</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">trobats</span> <span class="o">=</span> <span class="n">splitSeq</span><span class="o">(</span><span class="n">tupla</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">trobats</span><span class="o">.</span><span class="na">size</span><span class="o">()==</span><span class="mi">4</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">carrer</span> <span class="o">=</span> <span class="n">splitSeq</span><span class="o">(</span><span class="n">trobats</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span>
        <span class="n">String</span><span class="o">[]</span> <span class="n">elements</span> <span class="o">=</span> <span class="k">new</span> <span class="n">String</span><span class="o">[</span><span class="n">carrer</span><span class="o">.</span><span class="na">size</span><span class="o">()];</span>
        <span class="n">adr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Adressa</span><span class="o">(</span><span class="n">carrer</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">elements</span><span class="o">),</span>
                <span class="n">trobats</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="n">trobats</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="n">trobats</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">3</span><span class="o">));</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">adr</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>Fixa't com <em>parseAdressa()</em> crida dos cops a <em>splitSeq()</em>. El primer
per destriar els camps de l'adreça, i el segon per les diferents
línies del carrer.</p>
</div>
<div class="section" id="exercici-6-test-de-composicio-i-parser">
<h3>Exercici 6. ★ Test de composició i parser</h3>
<p>Desenvolupa codi de test per comprovar el funcionament dels mètodes
<em>composaCarrer()</em>, <em>composaAdressa()</em> i <em>parseAdressa()</em>.</p>
<p>És clar, si trobes un error de funcionament al codi que et
proporciona aquest document, avisa!</p>
</div>
<div class="section" id="implementacio-d-una-entitat">
<h3>Implementació d'una entitat</h3>
<p>Les entitats (no tipus) de la base de dades també trobaran
correspondència amb una classe de Java.</p>
<p>Com que volem recuperar instàncies guardades com a registres a una o
més taules de la base de dades, per després poder tornar a guardar les
modificacions sobre els mateixos registres, ens caldrà disposar de
l'identificador dels registres associat a les instàncies. La proposta
aquí és molt bàsica: afegim una propietat <em>îd</em> a la instància.</p>
<p>Per exemple, considera el següent codi que implementa la classe
<em>Comercial</em></p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Comercial</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Denominacio</span> <span class="n">nom</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Telefon</span> <span class="n">telefon</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">Comercial</span><span class="o">(</span><span class="n">Denominacio</span> <span class="n">nom</span><span class="o">,</span> <span class="n">Telefon</span> <span class="n">telefon</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="n">nom</span><span class="o">,</span> <span class="n">telefon</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">Comercial</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">Denominacio</span> <span class="n">nom</span><span class="o">,</span> <span class="n">Telefon</span> <span class="n">telefon</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">nom</span><span class="o">=</span><span class="n">nom</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">telefon</span><span class="o">=</span><span class="n">telefon</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span>       <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>   <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">int</span>         <span class="nf">getId</span><span class="o">()</span>      <span class="o">{</span> <span class="k">return</span> <span class="n">id</span><span class="o">;</span>      <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Denominacio</span> <span class="nf">getNom</span><span class="o">()</span>     <span class="o">{</span> <span class="k">return</span> <span class="n">nom</span><span class="o">;</span>     <span class="o">}</span>
    <span class="kd">public</span> <span class="n">Telefon</span>     <span class="nf">getTelefon</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">telefon</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="s">&quot;Comercial: &quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span>
            <span class="s">&quot;\n\tnom: &quot;</span><span class="o">+</span> <span class="n">nom</span> <span class="o">+</span>
            <span class="s">&quot;\n\ttelefon: &quot;</span> <span class="o">+</span> <span class="n">telefon</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Fixat:</p>
<ol class="arabic simple">
<li>La classe ofereix dos constructors. Quan creem una instància a
partir de les dades obtingudes d'una consulta a la base de dades,
disposarem de l'identificador (la clau primària d'aquesta). Quan
creem una nova instància, però, aquest identificador encara no
estarà assignat. Suposarem que si no ho està encara, aquest serà un
valor que no pugui ser representat com a identificador a la base de
dades. En concret aquí s'ha escollit el -1 <a class="footnote-reference" href="#messofisticat" id="id4">[5]</a>.</li>
<li>El camp <em>id</em> pot ser assignat amb posterioritat. És a dir, aquesta
classe no és immutable com ho era per exemple <em>Denominacio</em>.</li>
<li>La classe reescriu el mètode <em>toString()</em> per facilitar la prova.</li>
</ol>
</div>
<div class="section" id="exercici-7-client">
<h3>Exercici 7. Client</h3>
<p>Implementa la classe <em>Client</em> seguint les idees anteriors.</p>
</div>
<div class="section" id="carrega-d-una-entitat">
<h3>Càrrega d'una entitat</h3>
<p>Suposem que coneixem l'identificador del comercial a la base de dades.
Com podem obtenir les dades associades i a partir d'elles construir la
instància del comercial?</p>
<p>Considera el següent codi:</p>
<div class="highlight"><pre><span class="kd">public</span> <span class="n">Comercial</span> <span class="nf">carregaComercial</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Statement</span> <span class="n">st</span>  <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;SELECT * FROM COMERCIALS WHERE id =&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="o">;</span>
    <span class="n">Comercial</span> <span class="n">comercial</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">nomStr</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;nom&quot;</span><span class="o">);</span>
            <span class="n">String</span> <span class="n">telStr</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;tel&quot;</span><span class="o">);</span>
            <span class="n">Denominacio</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">VendesParser</span><span class="o">.</span><span class="na">parseDenominacio</span><span class="o">(</span><span class="n">nomStr</span><span class="o">);</span>
            <span class="n">Telefon</span> <span class="n">telefon</span> <span class="o">=</span> <span class="n">VendesParser</span><span class="o">.</span><span class="na">parseTelefon</span><span class="o">(</span><span class="n">telStr</span><span class="o">);</span>
            <span class="n">comercial</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Comercial</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">denom</span><span class="o">,</span> <span class="n">telefon</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">comercial</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
<p>Fixat:</p>
<ol class="arabic simple">
<li>Aquest mètode intenta trobar el comercial amb l'identificador
indicat. Si no el troba (o hi ha qualsevol problema amb la BD)
retorna el comercial <em>null</em>.</li>
<li>El mètode <em>absorbeix</em> qualsevol problema amb la base de dades.
Únicament mostra el traç de l'excepció per sortida estàndard. Si bé
és una manera còmoda de sortir-nos del pas aquí, potser no és gaire
adequada per aplicacions <em>reals</em>. És clar, no voldrem que la nostra
aplicació hagi de tractar amb excepcions SQL i que finalment pugui
arribar a l'usuari un missatge de la base de dades! Però tampoc
voldrem quedar-nos sense informació potser vital durant la
depuració. Considera la classe <a class="reference external" href="http://docs.oracle.com/javase/7/docs/api/java/util/logging/Logger.html">java.util.logging.Logger</a>.</li>
</ol>
</div>
<div class="section" id="exercici-8-test-de-carrega-de-comercial">
<h3>Exercici 8. ★ Test de càrrega de comercial</h3>
<p>El desenvolupament d'aquest test pot ser una mica <em>peculiar</em> ja que
haurem de tractar amb la base de dades i sabem, per la resposta del
mestre Flying Feathers a <a class="reference external" href="http://www.agitar.com/downloads/TheWayOfTestivus.pdf">The way of Testivus</a> a la secció
<em>The test is more important than the unit</em>, que:</p>
<blockquote>
<p>If it talks to the database, it is not a unit test</p>
<p>If it can't run at the same time as any other unit tests, it is not a unit test.</p>
<p>«...»</p>
<p>If you have to do special things to your environment to run it, it is not a unit test.</p>
</blockquote>
<p>Recorda la nota que va rebre l'estudiant aquella nit:</p>
<blockquote>
The answer from the great master Flying Feathers is an excellent
guide.  Follow it, and most of the time you will do well.  But
don’t get stuck on any dogma.  Write the test that needs to be
written&quot;.</blockquote>
<p>Amb aquest segon consell en ment, pots escriure unes proves que
preparin la base de dades amb les dades d'un comercial, després
executin el mètode a provar i finalment <em>netegin</em> la base de dades. No
serà una prova unitària <em>de mena</em> però de moment ens permetrà sortir
del pas (<em>An imperfect test today is better than a perfect test
someday</em>)</p>
<p>Com sempre, si descobreixes un error al codi, avisa.</p>
</div>
<div class="section" id="exercici-9-carrega-un-client">
<h3>Exercici 9. Carrega un client</h3>
<p>Fen servir de guia el codi de càrrega d'un comercial, implementa el
mètode <em>Client carregaClient(int id)</em> que carrega un client a partir
del seu identificador de la base de dades i retorna una instància de
<em>Client</em>.</p>
</div>
<div class="section" id="exercici-10-test-de-carrega-de-client">
<h3>Exercici 10. ★ Test de càrrega de client</h3>
<p>Afegeix el codi de prova per comprovar el funcionament del teu codi.</p>
</div>
<div class="section" id="exercici-11-carregant-clients">
<h3>Exercici 11. Carregant clients</h3>
<p>Anteriorment hem desenvolupat ja algunes classes i mètodes per
accedir a la base de dades.</p>
<p>Alguns mètodes, com ara els tipus <em>parser</em> els estem col·locant a la
classe <em>VendesParser</em>. Hi ha altres mètodes, però, que no tenim tan
clar on col·locar. Per exemple, on has posat els mètodes
<em>carregaComercial()</em> i <em>carregaClient()</em>?</p>
<p>En aquest exercici crearem la classe <em>VendesBD</em> que, com
<em>VendesParser</em> ens permetrà que classes com <em>Client</em> no hagin de
preocupar-se gaire de coses com l'emmagatzemament a la base de dades.</p>
<p>Així <em>VendesBD</em> encapsularà tot l'accés a la base de dades.  A
diferència de <em>VendesParser</em>, aquesta classe requerirà mantenir un
cert estat, com a mínim la connexió amb la base de dades. Només
voldrem una instància d'aquesta classe i ens interessarà poder accedir
a ella des de qualsevol mètode de la nostra aplicació (com si fos una
variable global).</p>
<p>Per donar resposta a aquestes característiques, hi ha un patró de
desenvolupament anomenat <a class="reference external" href="http://www.javaworld.com/javaworld/jw-04-2003/jw-0425-designpatterns.html">singleton</a>.
Donat que a la nostra aplicació sempre ens interessarà disposar de la
connexió, podrem implementar el patró d'una manera molt senzilla.
El codi següent podria servir de plantilla <a class="footnote-reference" href="#threadsafe" id="id5">[6]</a></p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">VendesBD</span> <span class="o">{</span>
    <span class="c1">// única instància de VendesBD per tot el procés</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">VendesBD</span> <span class="n">instancia</span> <span class="o">=</span> <span class="k">new</span> <span class="n">VendesBD</span><span class="o">();</span>

    <span class="c1">// connexió amb la base de dades</span>
    <span class="kd">private</span> <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">private</span> <span class="nf">VendesBD</span><span class="o">()</span> <span class="o">{}</span>

    <span class="cm">/* retorna la única instància de VendesBD</span>
<span class="cm">     * Si hi ha problemes de connexió genera una excepció RuntimeException */</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="n">VendesBD</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">RuntimeException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instancia</span><span class="o">.</span><span class="na">conn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>       <span class="c1">// primer cop o tancada?</span>
            <span class="n">instancia</span><span class="o">.</span><span class="na">conn</span> <span class="o">=</span> <span class="n">connecta</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">instancia</span><span class="o">.</span><span class="na">conn</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>   <span class="c1">// no es pot establir la connexió</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">RuntimeException</span><span class="o">(</span><span class="s">&quot;Sense connexió&quot;</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">instancia</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="cm">/* tanca la instància.*/</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tanca</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">instancia</span><span class="o">.</span><span class="na">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">instancia</span><span class="o">.</span><span class="na">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span> <span class="o">}</span>
            <span class="n">instancia</span><span class="o">.</span><span class="na">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="cm">/* Crea la connexió amb la base de dades.</span>
<span class="cm">     * Si ja hi havia una connexió, no fa res.</span>
<span class="cm">     * No genera error si no pot establir la connexió</span>
<span class="cm">     */</span>
    <span class="kd">private</span> <span class="kd">static</span> <span class="n">Connection</span> <span class="nf">connecta</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">usuari</span>   <span class="o">=</span> <span class="s">&quot;usuaribd&quot;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">&quot;pass&quot;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">host</span>     <span class="o">=</span> <span class="s">&quot;192.168.56.101&quot;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">bd</span>       <span class="o">=</span> <span class="s">&quot;testbd&quot;</span><span class="o">;</span>
        <span class="n">String</span> <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;jdbc:postgresql://&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">bd</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">usuari</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">conn</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="err">«</span><span class="o">...</span><span class="err">»</span>
<span class="o">}</span>
</pre></div>
<p>Per cridar a un mètode de <em>VendesBD</em> podem, per exemple</p>
<div class="highlight"><pre><span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">VendesBD</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">carregaClient</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
</pre></div>
<p>En acabar l'execució, és recomanable tancar la connexió amb la base de
dades. Per aquest fi disposem del mètode <em>tanca()</em> que hauria de ser
cridat quan ja no tinguem més necessitat de disposar de connexió a la
base de dades des del nostre programa.</p>
<p>A banda d'afegir-hi els mètodes que ja hem treballat abans (ex.
<em>carregaClient()</em>), per aquest exercici caldrà que implementis el
mètode públic <em>Client[] carregaClients()</em> que llegeix de la base de
dades tots els clients, construirà instàncies de Client i, agrupades
en un array, les retornarà. No consideris la taula de clients VIP en
aquest exercici.</p>
<p>La classe <em>UsaClient</em> consistirà en una funció <em>main()</em> que demanarà a
<em>VendesBD</em> la llista de tots els clients, i els mostrarà per sortida
estàndard. No oblidis de tancar la connexió en finalitzar.</p>
</div>
<div class="section" id="exercici-12-test-de-carrega-de-clients">
<h3>Exercici 12. ★ Test de càrrega de clients</h3>
<p>Probablement els canvis anteriors et requeriran reorganitzar el codi
de les teves proves. A més a més, segurament hi ha nous elements que
voldràs provar.</p>
<p>Realitza els canvis necessaris a la teva bateria de proves.</p>
</div>
</div>
<div class="section" id="herencia">
<h2>Herència</h2>
<p>A un <a class="reference external" href="./comparacio-models-relacional-i-objecte-relacionals-segona-part.html">tema anterior</a>
vàrem veure que PostGreSQL ens ofereix la clau <em>INHERITS</em> per
especificar una relació d'herència entre dues entitats.  Havíem fet
servir aquest mecanisme per relacionar <em>CLIENTS</em> amb <em>CLIENTS_VIP</em>.
També vàrem observar que es tracta d'una funcionalitat que encara no
està completament implementada pel SGBD.</p>
<p>Com que l'herència és un element bàsic a la POO, haurem de trobar un
camí alternatiu mentre els desenvolupadors d'aquest (per altra banda
fantàstic) SGBD, poden finalitzar la implementació d'aquest concepte.</p>
<p>L'aproximació que prendrem aquí és molt habitual en el model
relacional (sense Objecte-Relacional): l'entitat que estén disposa
d'una clau primària que és a l'hora forana de l'entidad estesa</p>
<div class="highlight"><pre><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">CLIENTS_VIP</span> <span class="p">(</span>
    <span class="n">id_client</span> <span class="nb">INTEGER</span> <span class="k">PRIMARY</span> <span class="k">KEY</span> <span class="k">REFERENCES</span> <span class="n">CLIENTS</span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
    <span class="n">id_comercial</span> <span class="nb">INTEGER</span> <span class="k">REFERENCES</span> <span class="n">COMERCIALS</span>
<span class="p">);</span>
</pre></div>
<p>D'aquesta manera, la taula de <em>CLIENTS_VIP</em> conté únicament les dades
que estén, mentre que <em>CLIENTS</em> conté la resta.</p>
<p>Farem que un client sigui VIP simplement afegint a <em>CLIENTS_VIP</em> una
entrada. Per exemple, la nostra clienta 20001 la farem VIP amb</p>
<div class="highlight"><pre><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">CLIENTS_VIP</span> <span class="k">VALUES</span> <span class="p">(</span><span class="mi">20001</span><span class="p">,</span> <span class="mi">40001</span><span class="p">);</span>
</pre></div>
<p>Per a accedir a les dades de tots els clients, siguin o no, VIP podem
fer</p>
<div class="highlight"><pre><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">CLIENTS</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">CLIENTS_VIP</span> <span class="k">ON</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">id_client</span><span class="p">);</span>
</pre></div>
<p>Aquesta consulta ens retornarà una columna <em>id_comercial</em> que
contindrà un valor nul en el cas que el client no correspongui a un
VIP.</p>
<p>Si fem una consulta d'aquesta manera amb el driver de PostGreSQL des
de Java, ens trobarem que els clients no VIP presenten un 0 al valor
del camp <em>id_comercial</em>. Potser ens interessaria que aquest valor fos
el -1 que estem fent servir en aquests materials. Això ho aconseguirem
amb <a class="footnote-reference" href="#coalesce" id="id6">[3]</a></p>
<div class="highlight"><pre><span class="k">SELECT</span> <span class="n">CLIENTS</span><span class="p">.</span><span class="o">*</span><span class="p">,</span> <span class="n">coalesce</span><span class="p">(</span><span class="n">id_comercial</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">AS</span> <span class="n">id_comercial</span>
<span class="k">FROM</span> <span class="n">CLIENTS</span> <span class="k">LEFT</span> <span class="k">OUTER</span> <span class="k">JOIN</span> <span class="n">CLIENTS_VIP</span> <span class="k">ON</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="n">id_client</span><span class="p">);</span>
</pre></div>
<p>D'aquesta manera, quan estem llegint un client podem fer</p>
<div class="highlight"><pre><span class="err">«</span><span class="o">...</span><span class="err">»</span>
<span class="kt">int</span> <span class="n">id_comercial</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;id_comercial&quot;</span><span class="o">);</span>
<span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
<span class="k">if</span> <span class="o">(</span><span class="n">id_comercial</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Client</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">denom</span><span class="o">,</span> <span class="n">adr</span><span class="o">,</span> <span class="n">telefons</span><span class="o">);</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">Comercial</span> <span class="n">comercial</span> <span class="o">=</span> <span class="n">carregaComercial</span><span class="o">(</span><span class="n">id_comercial</span><span class="o">);</span>
    <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClientVip</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">denom</span><span class="o">,</span> <span class="n">adr</span><span class="o">,</span> <span class="n">telefons</span><span class="o">,</span> <span class="n">comercial</span><span class="o">);</span>
<span class="o">}</span>
<span class="err">«</span><span class="o">...</span><span class="err">»</span>
</pre></div>
<p>Fixa't que en cas que el comercial ja hagi estat carregat al sistema
per un altre client, hi haurà instàncies duplicades del mateix
comercial.  És molt probable que a la teva aplicació no vulguis que
això passi. En aquest cas pots fer <em>trucs</em> com ara guardar-te la
llista d'entitats de comercials i mirar si el comercial cercat ja
apareix a la llista, abans de crear-ne una altra instància. Per
aquests exercicis introductoris, no cal que facis una versió tant
sofisticada.</p>
<div class="section" id="exercici-13-carregant-clients-vip">
<h3>Exercici 13. Carregant clients VIP</h3>
<p>Desenvolupa una nova versió de <em>UsaClient</em>. En aquesta ocasió, el
programa mostrarà la informació de tots els clients, incloent la dels
VIP.</p>
<p><em>Pista</em>: gràcies al polimorfisme probablement no et serà necessari
distingir quina mena de client t'arriba a <em>UsaClient</em>.</p>
</div>
<div class="section" id="exercici-14-test-de-carrega-de-clients-vip">
<h3>Exercici 14. ★ Test de càrrega de clients VIP</h3>
<p>Ja saps: codifica la prova del mètode o mètodes anteriors.</p>
</div>
<div class="section" id="guardant-clients">
<h3>Guardant clients</h3>
<p>A l'hora de guardar un client a la base de dades, cal tenir en compte
si es tracta d'un client VIP, i en aquest cas caldrà guardar també la
informació d'aquest.</p>
<p>Una manera seria crear dos mètodes:</p>
<div class="highlight"><pre><span class="n">VendesBD</span><span class="o">.</span><span class="na">guardaClient</span><span class="o">(</span><span class="n">Client</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span> <span class="err">«</span><span class="o">...</span><span class="err">»</span> <span class="o">}</span>
</pre></div>
<p>i</p>
<div class="highlight"><pre><span class="n">VendesBD</span><span class="o">.</span><span class="na">guardaClient</span><span class="o">(</span><span class="n">ClientVip</span> <span class="n">client</span><span class="o">)</span> <span class="o">{</span> <span class="err">«</span><span class="o">...</span><span class="err">»</span> <span class="o">}</span>
</pre></div>
<p>D'aquesta manera deixaríem la distinció del tipus de client al
compilador. Com que sovint, però, les nostres referències seran a
client tant si són VIP com si no, segurament ens serà més pràctic fer
una distinció amb l'operador <em>instanceof</em> <a class="footnote-reference" href="#principispooalterra" id="id7">[4]</a>.</p>
<p>Considera la implementació del següent mètode de <em>VendesBD</em></p>
<div class="highlight"><pre><span class="kd">public</span> <span class="kt">void</span> <span class="nf">guardaClient</span><span class="o">(</span><span class="n">Client</span> <span class="n">client</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="kt">boolean</span> <span class="n">esVip</span> <span class="o">=</span> <span class="o">(</span><span class="n">client</span> <span class="k">instanceof</span> <span class="n">ClientVip</span><span class="o">);</span>
    <span class="n">String</span> <span class="n">nom</span> <span class="o">=</span> <span class="n">composaDenominacio</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getNom</span><span class="o">());</span>
    <span class="n">String</span> <span class="n">adr</span> <span class="o">=</span> <span class="n">composaAdressa</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getAdr</span><span class="o">());</span>
    <span class="n">String</span> <span class="n">tel</span> <span class="o">=</span> <span class="n">composaTelefons</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">getTelefons</span><span class="o">());</span>
    <span class="kt">int</span> <span class="n">idClient</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">idClient</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">idClient</span> <span class="o">=</span> <span class="n">insertClientBD</span><span class="o">(</span><span class="n">nom</span><span class="o">,</span> <span class="n">adr</span><span class="o">,</span> <span class="n">tel</span><span class="o">);</span>
        <span class="n">client</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">idClient</span><span class="o">);</span> <span class="c1">// assigna l&#39;id del client</span>
    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
        <span class="n">updateClientBD</span><span class="o">(</span><span class="n">idClient</span><span class="o">,</span> <span class="n">nom</span><span class="o">,</span> <span class="n">adr</span><span class="o">,</span> <span class="n">tel</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">esVip</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">Comercial</span> <span class="n">comercial</span> <span class="o">=</span> <span class="o">((</span><span class="n">ClientVip</span><span class="o">)</span> <span class="n">client</span><span class="o">).</span><span class="na">getComercial</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">comercial</span><span class="o">.</span><span class="na">getComercial</span><span class="o">()</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">guardaComercial</span><span class="o">(</span><span class="n">comercial</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">insertOUpdateClientVipBD</span><span class="o">(</span><span class="n">idClient</span><span class="o">,</span> <span class="n">comercial</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
<p>Fixa't:</p>
<ol class="arabic simple">
<li>El mètode distingeix si ha de realitzar un <em>insert</em> o un <em>update</em> a
partir de l'identificador del client.</li>
<li>El codi inicialitza <em>esVip</em> segons sigui o no VIP. Més endavant, si
és VIP, se n'encarrega de guardar (també <em>insert</em> o <em>update</em>) el
comercial i la informació a la taula <em>CLIENTS_VIP</em>.</li>
<li>El codi de <em>composaDenominacio()</em> podria ser:</li>
</ol>
<div class="highlight"><pre><span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">composaDenominacio</span><span class="o">(</span><span class="n">Denominacio</span> <span class="n">d</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span> <span class="s">&quot;ROW(&#39;%s&#39;,&#39;%s&#39;,&#39;%s&#39;)&quot;</span><span class="o">,</span><span class="n">d</span><span class="o">.</span><span class="na">getTr</span><span class="o">(),</span> <span class="n">d</span><span class="o">.</span><span class="na">getNom</span><span class="o">(),</span> <span class="n">d</span><span class="o">.</span><span class="na">getCognoms</span><span class="o">());</span>
<span class="o">}</span>
</pre></div>
<ol class="arabic simple">
<li>El codi de <em>insertClientBD()</em> podria ser:</li>
</ol>
<div class="highlight"><pre>     <span class="kd">private</span> <span class="kt">int</span> <span class="nf">insertClientBD</span><span class="o">(</span><span class="n">String</span> <span class="n">nom</span><span class="o">,</span> <span class="n">String</span> <span class="n">adr</span><span class="o">,</span> <span class="n">String</span> <span class="n">tel</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
         <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">format</span><span class="o">(</span>
                 <span class="s">&quot;INSERT INTO CLIENTS (nom, adr, telefons) VALUES (%s,%s,CAST(%s AS Telefon[]))&quot;</span><span class="o">,</span>
                 <span class="n">nom</span><span class="o">,</span> <span class="n">adr</span><span class="o">,</span> <span class="n">tel</span><span class="o">);</span>
         <span class="k">return</span> <span class="n">insertElementBd</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
     <span class="o">}</span>

<span class="n">amb</span>
</pre></div>
<div class="highlight"><pre><span class="cm">/* Executa una query que generarà una única clau i la retorna */</span>
<span class="kd">private</span> <span class="kt">int</span> <span class="nf">insertElementBd</span><span class="o">(</span><span class="n">String</span> <span class="n">sql</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
    <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
        <span class="n">st</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">Statement</span><span class="o">.</span><span class="na">RETURN_GENERATED_KEYS</span><span class="o">);</span>
        <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">getGeneratedKeys</span><span class="o">();</span>
        <span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
        <span class="n">id</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
        <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
<span class="o">}</span>
</pre></div>
</div>
<div class="section" id="exercici-15-guardant-client">
<h3>Exercici 15. Guardant client</h3>
<p>Completa el codi necessari per que funcioni el mètode
<em>VendesBD.guardaClient(Client)</em> a partir de les idees anteriors.</p>
<p>Amplia <em>UsaClient</em> de manera que mostri com s'afegeix un nou client i
com es modifica un d'existent.</p>
</div>
<div class="section" id="exercici-16-test-de-guardar-client">
<h3>Exercici 16. ★ Test de guardar client</h3>
<p>Aquí també hauràs de fer una prova amb la base de dades. En aquest
cas, però, inicialment segurament voldràs assegurar-te que el client
que vols guardar encara no hi sigui.</p>
</div>
<div class="section" id="exercici-17-entorn-operatiu-de-vendes">
<h3>Exercici 17. Entorn operatiu de Vendes</h3>
<p>Crea un nou projecte amb Maven anomenat <em>vendes</em> que ofereixi
una senzilla consola que mostri el <em>prompt</em>:</p>
<pre class="literal-block">
[vendes]:
</pre>
<p>L'aplicació oferirà les següents opcions:</p>
<ul>
<li><p class="first">help</p>
<p>mostra la llista de comandes vàlides</p>
</li>
<li><p class="first">list «element»</p>
<p>On «element» pot ser un dels següents valors: clients, vips, comandes, comercials, productes.</p>
<p>Mostra la llista de clients, clients vip, comandes, comercials o
productes.</p>
<p>En cas que no hi hagi cap element dels demanats, l'aplicació
ho indicarà amb el missatge:</p>
<pre class="literal-block">
No s'ha trobat cap «element»
</pre>
<p>En cas que es demani un tipus d'element que no correspongui amb un
dels cinc indicats, l'aplicació mostrarà el missatge:</p>
<pre class="literal-block">
Element «element»
</pre>
<p>A l'hora de mostrar els clients, es farà omplint la següent
plantilla per cada client:</p>
<pre class="literal-block">
Client [ «nif» ]: «tractament» «nom» «cognom»
    Tel.: «tipus» «prefix» «nr.»
          «tipus» «prefix» «nr.»
          «...»
    Adr.: «primera línia carrer»
          «segona línia carrer»
          «...»
          «codi postal» «ciutat»
          «país»
</pre>
<p>A l'hora de mostrar els clients VIP, la plantilla serà molt similar
a la de clients:</p>
<pre class="literal-block">
Client VIP [ «nif» ]: «tractament» «nom» «cognom»
    Tel.: «tipus» «prefix» «nr.»
          «tipus» «prefix» «nr.»
          «...»
    Adr.: «primera línia carrer»
          «segona línia carrer»
          «...»
          «codi postal» «ciutat»
          «país»
    Comercial: «tractament» «nom» «cognom»
</pre>
<p>Quan el client demana mostrar la llista de clients, apareixeran
barrejats tant
els clients VIPs com els que no ho siguin. Amb tot, els clients VIPs
es mostraran amb la seva pròpia plantilla.</p>
<p>Els comercials es mostraran segons la plantilla:</p>
<pre class="literal-block">
Comercial:
</pre>
<p>Les comandes es mostraran segons la plantilla
<a class="footnote-reference" href="#simplicitatidcomanda" id="id8">[7]</a>:</p>
<pre class="literal-block">
Comanda [«id»]
    data: «dia/mes/any»
    client: [«nif»]: «tractament» «nom» «cognom»
    detall:
         nr  producte       quantitat   preu unit      import
        001: «nom producte» «quantitat» «preu unitari» «import»
        002: «nom producte» «quantitat» «preu unitari» «import»
        «...»
    import total: «import total de la comanda»
</pre>
<p>En el cas dels productes, es mostraran segons la plantilla
<a class="footnote-reference" href="#simplicitatidproducte" id="id9">[8]</a>:</p>
<pre class="literal-block">
Producte [«id»]: «nom»
    preu unitari: «preu»
    estoc: «estoc»
</pre>
</li>
<li><p class="first">add client</p>
<p>Permet donar d'alta un client. L'aplicació demanarà interactivament
les següents dades tot indicant el nom de la dada seguit de dos
punts.</p>
<ul class="simple">
<li>nif:</li>
<li>nom:</li>
<li>cognoms:</li>
<li>telèfon 1<ul>
<li>tipus de telèfon (m: mòbil, i: fix, a: fax, x: finalitzar telèfon)</li>
<li>prefix:</li>
<li>número:</li>
</ul>
</li>
<li>telèfon 2<ul>
<li>«...»</li>
</ul>
</li>
<li>adreça<ul>
<li>carrer (introduir línies amb la darrera en blanc per finalitzar):</li>
<li>codi postal:</li>
<li>ciutat:</li>
<li>país:</li>
</ul>
</li>
</ul>
<p>En cas que el nif proporcionat pertanyi a un client existent,
s'indicarà l'error i se li permetrà corregir o cancel·lar l'alta:</p>
<pre class="literal-block">
Ja existeix un client amb aquest nif. e: editar, c: cancelar
</pre>
<p>En el moment en que l'usuari indiqui 'x' al tipus de telèfon, ja no
se li demanarà més dades de telèfon.</p>
<p>Es requerirà especificar al menys un telèfon.</p>
<p>En el moment en que l'usuari introdueixi una línia en blanc, es
considerarà finalitzada la introducció de línies de carrer.</p>
<p>Es requerirà especificar al menys una línia de carrer.</p>
<p>Un cop obtingudes totes les dades, es mostraran (segons plantilla de
client) i es demanarà confirmació amb el missatge:</p>
<pre class="literal-block">
Procedir als canvis (s: sí, e: editar, c: cancelar)
</pre>
<p>En cas que l'usuari respongui 's', es donarà d'alta el client i, si
tot ha anat correcte, mostrarà el missatge:</p>
<pre class="literal-block">
D'acord
</pre>
<p>En cas que la resposta sigui 'c', es mostrarà el missatge:</p>
<pre class="literal-block">
Cap canvi
</pre>
<p>Finalment, per qualsevol altra resposta es procedirà a editar les
dades del client (veure opció <em>edit</em>)</p>
</li>
<li><p class="first">set client «nif client» as vip «nif comercial»</p>
<p>Converteix un client estàndard a VIP, o si ja ho era, li assigna un
nou comercial.</p>
<p>En cas que el nif del client no correspongui a cap client de la base
de dades, es mostrarà el missatge:</p>
<pre class="literal-block">
No es troba cap client amb el nif «nif client»
</pre>
<p>De la mateixa manera, si no es troba cap comercial amb el nif
indicat, es mostrarà el missatge:</p>
<pre class="literal-block">
No es troba cap comercial amb el nif «nif client»
</pre>
<p>En cas d'error, se li mostrarà l'opció de tornar a intentar-ho o bé
cancel·lar la comanda:</p>
<pre class="literal-block">
Premi r per reintentar o c per cancel·lar.
</pre>
<p>Un cop es disposi de totes les dades correctes, es mostrarà els
canvis a realitzar (plantilla client VIP) i es demanarà confirmació:</p>
<pre class="literal-block">
Aplicar els canvis (s: sí, c: cancel·lar)
</pre>
<p>Es respondrà de la manera especificada a la confirmació de l'alta de
client.</p>
</li>
<li><p class="first">unset vip «nif»</p>
<p>Converteix un client vip a un client normal. És a dir, s'elimina
l'associació del client amb un comercial.</p>
<p>En cas que el client no sigui vip, s'indicarà amb el missatge:</p>
<pre class="literal-block">
El client no era vip
</pre>
<p>Altrament, es demanarà confirmació:</p>
<pre class="literal-block">
Fer que el client deixi de ser vip (s: sí, c: cancelar)
</pre>
</li>
<li><p class="first">add comanda</p>
<p>Permet afegir una nova comanda.</p>
<p>Demanarà interactivament les dades de la comanda:</p>
<ul class="simple">
<li>nif del client:</li>
<li>data («data actual»):</li>
<li>línies de comanda:<ul>
<li>producte línia 001 (blanc per finalitzar):</li>
<li>quantitat</li>
</ul>
</li>
</ul>
<p>En cas que el nif proporcionat no correspongui a un client conegut
es mostrarà el missatge d'error corresponent com a l'opció
de convertir client a client vip.</p>
<p>En quan a la data, es proposarà la data d'avui (en format
dia/mes/any). Si l'usuari prem enter (cadena en blanc), es
considerarà que accepta la data proposada.</p>
<p>El producte de les línies de comanda s'especificarà mitjançant
l'identificador de producte. Si no es troba cap producte amb aquest
id, s'indicarà l'error amb el missatge:</p>
<pre class="literal-block">
No es troba cap producte amb l'identificador «id»
</pre>
</li>
<li><p class="first">add «element»</p>
<p>On element pot ser comercial o producte.</p>
<p>La interacció és molt similar a afegir client</p>
</li>
<li><p class="first">edit client «nif»</p>
<p>Permet modificar qualsevol de les dades de client (excepte l'id
intern)</p>
<p>En cas que el nif no correspongui a cap client, es mostrarà el
missatge d'error corresponent. Si l'usuari vol tornar-ho a intentar,
haurà de tornar a llençar la comanda un altre cop.</p>
<p>Demanarà cada dada pel seu nom, seguit del valor actual entre
parèntesis. D'aquesta manera, si l'usuari vol, pot respondre en
blanc per conservar el valor previ. Per exemple, amb el nif:</p>
<pre class="literal-block">
nif («nif actual»):
</pre>
<p>Finalment es procedirà a mostrar les dades recollides i a demanar
confirmació a l'estil de l'alta de client.</p>
<p>Per simplicitat, encara que el client correspongui a un client VIP,
no es permetrà editar el nif del comercial associat.</p>
<p>En cas que aparegui algun error (ex. el nou nif correspongui a un
altre client) es mostrarà el missatge d'error corresponent.</p>
</li>
<li><p class="first">edit «element» «id»</p>
<p>Permet editar les dades d'una comanda, comercial o producte.</p>
<p>En cas de ser un comercial, «id» es refereix al seu nif.</p>
<p>El comportament és molt similar al de la modificació de client.</p>
</li>
<li><p class="first">del «element» «id»</p>
<p>Permet eliminar un client, comercial, producte o comanda.</p>
<p>En cas que l'element sigui un client o un comercial, «id» es
refereix al seu nif.</p>
<p>En cas que no es pugui trobar cap element amb aquest identificador,
es mostrarà el missatge d'error corresponent seguit del prompt.</p>
<p>En cas que s'hagi trobat l'element a eliminar, es mostrarà les seves
dades amb la plantilla corresponent, i es demanarà confirmació.</p>
<p>En el cas d'eliminar un client, cal tenir present que pot tenir
comandes associades. Per això, al final de les dades del client,
caldrà indicar que s'eliminaran també les comandes del client:</p>
<pre class="literal-block">
S'eliminaran «n» comandes
</pre>
<p>En el cas de productes o comercials, no es permetrà eliminar-los si
tenen comandes o clients associats (respectivament) amb el missatge:</p>
<pre class="literal-block">
No es pot eliminar el producte perquè té les següents comandes
associades:
    «capçalera de cada comanda»
</pre>
<p>o:</p>
<pre class="literal-block">
No es pot eliminar el comercial perquè té els següents clients
associats: ::
    «nif» «tractament» «nom» «cognoms»
    «...»
</pre>
</li>
<li><p class="first">show «element»</p>
<p>Permet mostrar els detalls d'un element (client o comercial)</p>
<p>En cas de client, es mostrarà, a banda de les dades del client
(segons plantilla), les dades resumides de les comandes realitzades
(la plantilla de comandes sense el detall de línies) i l'import
total de totes les comandes realitzades.</p>
<p>En el cas de comercial, es mostrarà, a banda de les dades del
comercial, la llista de clients associats. Es tracta de la plantilla
completa de client vip (per simplicitat s'accepta la redundància de
mostrar el nif del comercial) més l'import total de les comandes del
client (sense detall de comandes). Finalment, es mostrarà l'import
total de les despeses de tots els clients del comercial.</p>
</li>
<li><p class="first">quit</p>
<p>Finalitzarà l'aplicació</p>
</li>
</ul>
<div class="section" id="requeriments-addicionals">
<h4>Requeriments addicionals</h4>
<p>Estructura el projecte de manera similar a la descrita a l'<a class="reference external" href="./jdbc-ii-model-relacional.html">exercici 2
del model relacional</a></p>
<p>De la mateixa manera, l'aplicació vendes requerirà la contrasenya per
a poder connectar a la base de dades i es comportarà de com al
gestoranimals.</p>
</div>
<div class="section" id="pistes">
<h4>Pistes</h4>
<p>A banda de les pistes de l'<a class="reference external" href="./jdbc-ii-model-relacional.html">exercici 2 del model relacional</a>,
considera:</p>
<ul class="simple">
<li>realitzar les modificacions completes. És a dir, encara que s'hagi
modificat només un número de telèfon d'un client, es guarda <strong>tot</strong>
el client.</li>
</ul>
</div>
</div>
<div class="section" id="exercici-18-prova-de-vendes">
<h3>Exercici 18. ★ Prova de Vendes</h3>
<p>En aquest exercici d'ampliació, et proposo que agrupis totes les
proves que hagis preparat en els exercicis d'ampliació previs.</p>
<p>A més, potser voldràs provar que funcionen les diferents restriccions
(ex. que no es puguin eliminar comercials amb clients associats, o que
la informació d'import total de client sigui l'esperada...)</p>
<p>Com a l'ampliació de  l'<a class="reference external" href="./jdbc-ii-model-relacional.html">exercici 2 del model relacional</a>, no cal que
implementis proves amb un 100% de cobertura.  Únicament recorda que
per poc que facis en aquest exercici, segur que el codi de la teva
aplicació i, el més important, la teva manera de codificar, hauran
millorat ostensiblement. Fes la prova!</p>
</div>
</div>
<div class="section" id="notes">
<h2>Notes</h2>
<table class="docutils footnote" frame="void" id="suportstruct" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>En el moment en que es va composar aquest document,
el driver <em>oficial</em> de PostGreSQL encara no disposava
d'implementació per la interfície <tt class="docutils literal">java.sql.Struct</tt> que seria la
que ens aniria bé aquí. Qui no té paciència ha de tenir recursos...</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="regexsimple" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Veureu que s'han realitzat algunes modificacions al
string que conté la tupla, de manera que l'expressió regular sigui
més senzilla. Si et ve de gust intentar-ho sense aquests trucs,
estaré encantat si la vols compartir.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="coalesce" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id6">[3]</a></td><td>Un agraïment per l'alumne Gerardo Galán que tan
oportunament ens va apuntar cap aquesta solució.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="principispooalterra" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label">[4]</td><td><em>(<a class="fn-backref" href="#id3">1</a>, <a class="fn-backref" href="#id7">2</a>)</em> Sabem que aquesta no és una bona pràctica en
programació orientada a objectes. És cert. Les classes
<em>VendesParser</em> i <em>VendesBD</em> saben <em>massa</em> de les intimitats
d'altres classes com ara <em>Denominacio</em>. Per tant, estem creant
dependències important. Amb tot, aquest tipus de classes ens
permeten agrupar elements complexos en un sol lloc i és una
pràctica coneguda i molt utilitzada.  Considera-ho com una mena de
catifa on escombrem la brossa un dia amb pressesa.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="messofisticat" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id4">[5]</a></td><td>Si vols fer-ho més sofisticat, pots codificar
l'identificador amb un <em>Integer</em> i posar-lo a <em>null</em> quan no
estigui assignat.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="threadsafe" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id5">[6]</a></td><td>En aquests materials no estem considerant els
problemes que poden esdevenir d'una execució multifil
(<em>multithread</em>).</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="simplicitatidcomanda" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id8">[7]</a></td><td>Per simplicitat, farem servir directament
l'identificador intern de la taula COMANDES.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="simplicitatidproducte" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id9">[8]</a></td><td>Per simplicitat, farem servir directament
l'identificador intern de la taula PRODUCTES, tot i que en un
context més real, probablement disposaríem d'un SKU (Stock Keep
Unit) o nr. de referència.</td></tr>
</tbody>
</table>
</div>
</div>
<div class="well small">
<ul id="navigation"> 
    <li class="navigation-prev">
    <a href="./jdbc-ii-model-relacional.html">
        JDBC II. Model relacional
    </a>
    </li>

    <li class="navigation-top">
    <a href="./jdbc-i-introduccio-al-jdbc.html">
        inici
    </a>
    </li>

</ul> 
</div>
</div>
<footer>
  <p>
  <a href=".">Apunts tècnics</a> 
  &copy; 
  <a href="http://www.gnu.org/copyleft/fdl.html">GNU FDL</a>
  per <i>Moisès Gómez Girón </i> (<img style="position:relative;top:+5px;border:0; display:inline;" src="./images/adressamoi.png">)
  amb el generador de blocs <a href="http://getpelican.com/">Pelican</a> 
    </p><p style="background:red; text-align:center;font-weight:bold;font-size:large;margin-left:30px;">Atenció: aquests continguts seran eliminats en breu. Si et cal fer còpia d'alguna pàgina, ara és un bon moment.
  </p>
</footer>    </div>
</div>

</body>
</html>
