<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Apunts tècnics: JDBC II. Model relacional</title>
<meta name="description" content="">
<meta name="author" content="Moisès Gómez Girón">

<!-- HTML5 shim, for IE6-8 support of HTML elements -->
<!--[if lt IE 9]>
        <script src="./theme/html5.js"></script>
    <![endif]-->

<!-- Styles -->
<link href="./theme/bootstrap.moi.css" rel="stylesheet">
<link href="./theme/local.css" rel="stylesheet">
<link href="./theme/pygments.css" rel="stylesheet">

<!-- Feeds -->
<link href="http://apuntstecnics.herokuapp.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Apunts tècnics Atom Feed" />

</head>
<body>

<div class="topbar">
    <div class="topbar-inner">
        <div class="container-fluid">
            <a class="brand" href="./">[Apunts tècnics]
 JDBC II. Model relacional             </a>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="sidebar">
        <div class="well">
            <!--
            <h3>Temes</h3>
                <ul>
                </ul>
            -->
            <h3>Categories</h3>
            <ul>
                <li class="active"><a href="./category/bd.html">bd</a></li>
                <li ><a href="./category/dev.html">dev</a></li>
                <li ><a href="./category/eines.html">eines</a></li>
                <li ><a href="./category/misc.html">misc</a></li>
                <li ><a href="./category/poo.html">poo</a></li>
                <li ><a href="./category/programacio.html">programacio</a></li>
                <li ><a href="./category/uml.html">uml</a></li>
            </ul>
            <h3>Tags</h3>
            <ul>
                <li><a href="./tag/c.html">C</a></li>
                <li><a href="./tag/jdbc.html">JDBC</a></li>
                <li><a href="./tag/java.html">java</a></li>
                <li><a href="./tag/programari.html">programari</a></li>
                <li><a href="./tag/util.html">util</a></li>
                <li><a href="./tag/test.html">test</a></li>
                <li><a href="./tag/postgresql.html">PostGreSQL</a></li>
            </ul>
        </div>
    </div>

    <div class="content">
<div class='article'>
<div class="well small">
<ul id="navigation"> 
    <li class="navigation-prev">
    <a href="./primeres-consultes-a-postgresql.html">
        Primeres consultes a PostGreSQL
    </a>
    </li>

    <li class="navigation-top">
    <a href="./jdbc-i-introduccio-al-jdbc.html">
        inici
    </a>
    </li>

    <li class="navigation-next">
    <a href="./jdbc-iii-model-objecte-relacional.html">
        JDBC III. Model Objecte-Relacional
    </a>
    </li>
</ul> 
</div>
    <div class="page-header"><h1>JDBC II. Model relacional</h1></div>
<div class="well small">
    Entrada ubicada a la categoria
    <a href="./category/bd.html">
        bd
    </a>
            amb els tags: 
            <a href="./tag/postgresql.html">PostGreSQL</a> 
            <a href="./tag/java.html">java</a> 
</div>
    <div><div class="section" id="introducio">
<h2>Introdució</h2>
<p>Amb aquests continguts treballarem la manera de comunicar els nostres
programes orientats a objecte amb les nostres bases de dades objecte
relacionals.</p>
<p>A aquesta segona part es treballa amb el JDBC per a comunicar-nos amb
una base de dades que disposi d'un model relacional <em>bàsic</em>. La
comunicació amb una base de dades amb característiques
Objecte-Relacional es deixa per la tercera part.</p>
</div>
<div class="section" id="jdbc-sobre-sgbd">
<h2>JDBC sobre SGBD</h2>
<p>En aquesta secció considerarem la manera bàsica de comunicar-nos amb
la base de dades.</p>
<p>Estudiem el següent codi:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Animal</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>     <span class="c1">// valor de la clau primària a ANIMALS</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">nom</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">categoria</span><span class="o">;</span>
    <span class="kd">public</span> <span class="nf">Animal</span><span class="o">(</span><span class="n">String</span> <span class="n">nom</span><span class="o">,</span> <span class="n">String</span> <span class="n">categoria</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">(-</span><span class="mi">1</span><span class="o">,</span> <span class="n">nom</span><span class="o">,</span> <span class="n">categoria</span><span class="o">);</span> <span class="c1">// encara no té identificador</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="nf">Animal</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">nom</span><span class="o">,</span> <span class="n">String</span> <span class="n">categoria</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">nom</span> <span class="o">=</span> <span class="n">nom</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">categoria</span> <span class="o">=</span> <span class="n">categoria</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">)</span>    <span class="o">{</span> <span class="k">this</span><span class="o">.</span><span class="na">id</span><span class="o">=</span><span class="n">id</span><span class="o">;</span>       <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getNom</span><span class="o">()</span>       <span class="o">{</span> <span class="k">return</span> <span class="n">nom</span><span class="o">;</span>       <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">getCategoria</span><span class="o">()</span> <span class="o">{</span> <span class="k">return</span> <span class="n">categoria</span><span class="o">;</span> <span class="o">}</span>
    <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">(){</span>
        <span class="k">return</span> <span class="s">&quot;(&quot;</span> <span class="o">+</span> <span class="n">id</span> <span class="o">+</span> <span class="s">&quot;, &#39;&quot;</span> <span class="o">+</span> <span class="n">nom</span> <span class="o">+</span> <span class="s">&quot;&#39;, &#39;&quot;</span> <span class="o">+</span> <span class="n">categoria</span> <span class="o">+</span> <span class="s">&quot;&#39;)&quot;</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table><p>i</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217</pre></div></td><td class="code"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">java.sql.*</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UsaAnimal</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>    <span class="c1">// connexió</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">connecta</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">conn</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">String</span> <span class="n">usuari</span>   <span class="o">=</span> <span class="s">&quot;usuaribd&quot;</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">password</span> <span class="o">=</span> <span class="s">&quot;pass&quot;</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">host</span>     <span class="o">=</span> <span class="s">&quot;192.168.56.101&quot;</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">bd</span>       <span class="o">=</span> <span class="s">&quot;testbd&quot;</span><span class="o">;</span>
            <span class="n">String</span> <span class="n">url</span>      <span class="o">=</span> <span class="s">&quot;jdbc:postgresql://&quot;</span> <span class="o">+</span> <span class="n">host</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">bd</span><span class="o">;</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">DriverManager</span><span class="o">.</span><span class="na">getConnection</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="n">usuari</span><span class="o">,</span> <span class="n">password</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Connectat amb &quot;</span> <span class="o">+</span> <span class="n">url</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// tanca la connexió en cas que estigui connectada</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">desconnecta</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">conn</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span> <span class="n">conn</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{}</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Desconnectat&quot;</span><span class="o">);</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// crea la taula d&#39;animals</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">creaTaula</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">eliminaTaula</span><span class="o">();</span> <span class="c1">// eliminem si ja existia</span>
        <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span>
                <span class="s">&quot;CREATE TABLE  ANIMALS (&quot;</span> <span class="o">+</span>
                <span class="s">&quot;       id        SERIAL PRIMARY KEY,&quot;</span> <span class="o">+</span>
                <span class="s">&quot;       nom       TEXT,              &quot;</span> <span class="o">+</span>
                <span class="s">&quot;       categoria VARCHAR(40))&quot;</span><span class="o">;</span>
            <span class="n">st</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Creada taula ANIMALS&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// elimina la taula d&#39;animals si existeix</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">eliminaTaula</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;DROP TABLE IF EXISTS ANIMALS&quot;</span><span class="o">;</span>
            <span class="n">st</span><span class="o">.</span><span class="na">executeUpdate</span> <span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Eliminada taula ANIMALS&quot;</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// mostra la llista d&#39;animals</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">consulta</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;SELECT * FROM ANIMALS ORDER BY nom&quot;</span><span class="o">;</span>
        <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="kt">int</span> <span class="n">nAnimals</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">())</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">nom</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;nom&quot;</span><span class="o">);</span>
                <span class="n">String</span> <span class="n">cat</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getString</span><span class="o">(</span><span class="s">&quot;categoria&quot;</span><span class="o">);</span>
                <span class="n">Animal</span> <span class="n">animal</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Animal</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">nom</span><span class="o">,</span> <span class="n">cat</span><span class="o">);</span>
                <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">animal</span><span class="o">);</span>
                <span class="n">nAnimals</span><span class="o">++;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">nAnimals</span><span class="o">==</span><span class="mi">0</span><span class="o">)</span> <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Cap animal de moment&quot;</span><span class="o">);</span>
            <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// retorna el nombre d&#39;animals que hi ha insertats</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">comptaAnimals</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">SELECT_SQL</span> <span class="o">=</span> <span class="s">&quot;SELECT COUNT(*) FROM Animals&quot;</span><span class="o">;</span>
        <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeQuery</span><span class="o">(</span><span class="n">SELECT_SQL</span><span class="o">);</span>
            <span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;El nombre d&#39;animals a la bd és: &quot;</span> <span class="o">+</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">));</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// afegeix un animal a la taula i obté l&#39;id generat</span>
    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">afegeixAnimal</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="c1">// crea l&#39;animal</span>
        <span class="n">Animal</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Animal</span><span class="o">(</span><span class="s">&quot;canari&quot;</span><span class="o">,</span> <span class="s">&quot;ocell&quot;</span><span class="o">);</span>
        <span class="c1">// crea la comanda</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO ANIMALS (nom, categoria) values (&#39;&quot;</span>
            <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="na">getNom</span><span class="o">()</span>
            <span class="o">+</span> <span class="s">&quot;&#39;, &#39;&quot;</span>
            <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="na">getCategoria</span><span class="o">()</span>
            <span class="o">+</span> <span class="s">&quot;&#39;)&quot;</span><span class="o">;</span>
        <span class="c1">// envia la comanda</span>
        <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">Statement</span><span class="o">.</span><span class="na">RETURN_GENERATED_KEYS</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Nombre d&#39;animals afegits: &quot;</span> <span class="o">+</span> <span class="n">num</span><span class="o">);</span>
            <span class="n">ResultSet</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">getGeneratedKeys</span><span class="o">();</span>
            <span class="n">rs</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">rs</span><span class="o">.</span><span class="na">getInt</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
            <span class="n">a</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>        <span class="c1">// assignem l&#39;id de l&#39;animal</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Afegit l&#39;animal &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="o">);</span>
            <span class="n">rs</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="c1">// afegeix uns quants animals a la taula</span>
    <span class="c1">// Ho fa com a transacció (o tots o cap)</span>
    <span class="c1">// Fa servir un PreparedStatement per optimitzar repetides crides</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">afegeixMoltsAnimals</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="c1">// plantilla de la sentència d&#39;inserció</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;INSERT INTO Animals (nom, categoria) values (?,?)&quot;</span><span class="o">;</span>

        <span class="c1">// crea els animals</span>
        <span class="n">Animal</span><span class="o">[]</span> <span class="n">llista</span> <span class="o">=</span> <span class="o">{</span>
            <span class="k">new</span> <span class="n">Animal</span><span class="o">(</span><span class="s">&quot;estruç&quot;</span><span class="o">,</span> <span class="s">&quot;ocell&quot;</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">Animal</span><span class="o">(</span><span class="s">&quot;kiwi&quot;</span><span class="o">,</span> <span class="s">&quot;ocell&quot;</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">Animal</span><span class="o">(</span><span class="s">&quot;gos&quot;</span><span class="o">,</span> <span class="s">&quot;mamifer&quot;</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">Animal</span><span class="o">(</span><span class="s">&quot;bacallà&quot;</span><span class="o">,</span> <span class="s">&quot;peix&quot;</span><span class="o">),</span>
            <span class="k">new</span> <span class="n">Animal</span><span class="o">(</span><span class="s">&quot;dofí&quot;</span><span class="o">,</span> <span class="s">&quot;peix&quot;</span><span class="o">)</span>
        <span class="o">};</span>

        <span class="c1">// obté l&#39;estat anterior de l&#39;autocommit.</span>
        <span class="kt">boolean</span> <span class="n">anteriorAutoCommit</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">getAutoCommit</span><span class="o">();</span>
        <span class="c1">// fem que no faci autocommit a cada execució</span>
        <span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

        <span class="n">PreparedStatement</span> <span class="n">ps</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="c1">// crea la sentència a executar (només un cop!)</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">prepareStatement</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">for</span> <span class="o">(</span><span class="n">Animal</span> <span class="n">a</span><span class="o">:</span> <span class="n">llista</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// afegim els valors a insertar</span>
                    <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="na">getNom</span><span class="o">());</span>       <span class="c1">// primer camp</span>
                    <span class="n">ps</span><span class="o">.</span><span class="na">setString</span><span class="o">(</span><span class="mi">2</span><span class="o">,</span> <span class="n">a</span><span class="o">.</span><span class="na">getCategoria</span><span class="o">());</span> <span class="c1">// segon camp</span>
                    <span class="n">ps</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">();</span>
                    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Afegit l&#39;animal &quot;</span> <span class="o">+</span> <span class="n">a</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="c1">// si no hi ha problemes accepta tot</span>
                <span class="n">conn</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">SQLException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// trobat problemes amb la inserció: tot enrere</span>
                <span class="n">conn</span><span class="o">.</span><span class="na">rollback</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="c1">// tornem l&#39;estat de autocomit tal i com estava</span>
                <span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="n">anteriorAutoCommit</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ps</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">ps</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">corregeixAnimals</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="c1">// tenim el dofí en una categoria equivocada. Canviem-la a la BD</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">&quot;UPDATE Animals set categoria = &#39;mamifer&#39; WHERE nom = &#39;dofí&#39;&quot;</span><span class="o">;</span>
        <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="n">sql</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Modificat animals: &quot;</span> <span class="o">+</span> <span class="n">num</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">eliminaOcells</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SQLException</span> <span class="o">{</span>
        <span class="c1">// volem eliminar tots els ocells de la bd</span>
        <span class="n">String</span> <span class="n">DELETE_SQL</span> <span class="o">=</span> <span class="s">&quot;DELETE FROM Animals WHERE categoria = &#39;ocell&#39;&quot;</span><span class="o">;</span>
        <span class="n">Statement</span> <span class="n">st</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">st</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">();</span>
            <span class="kt">int</span> <span class="n">num</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="na">executeUpdate</span><span class="o">(</span><span class="n">DELETE_SQL</span><span class="o">);</span>
            <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Eliminats ocells: &quot;</span> <span class="o">+</span> <span class="n">num</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">st</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span> <span class="n">st</span><span class="o">.</span><span class="na">close</span><span class="o">();</span> <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">UsaAnimal</span> <span class="n">ua</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">ua</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UsaAnimal</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">connecta</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">creaTaula</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">consulta</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">afegeixAnimal</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">afegeixMoltsAnimals</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">consulta</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">corregeixAnimals</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">consulta</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">eliminaOcells</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">consulta</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">comptaAnimals</span><span class="o">();</span>
            <span class="n">ua</span><span class="o">.</span><span class="na">eliminaTaula</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span><span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ua</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="n">ua</span><span class="o">.</span><span class="na">desconnecta</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</td></tr></table><div class="section" id="exercici-1-jdbc-en-funcionament">
<h3>Exercici 1. JDBC en funcionament</h3>
<p>Contesta les següents preguntes respecte el codi anterior. Algunes de
les preguntes potser requeriran que revisis la documentació oficial.</p>
<ol class="arabic simple">
<li>Quines diferències hi trobes entre executar una comanda sql que
potencialment modifica registres i una altra que fa una consulta?</li>
<li>Què passa si tanques un <em>Statement</em> que ja està tancat?</li>
<li>Què passa si no tanques un <em>ResultSet</em>?</li>
<li>Com s'assegura aquest codi que es tanquen els <em>Statement</em> passi el
que passi?</li>
<li>Seria possible fer servir una única instància de <em>Statement</em> per a
totes les operacions d'aquest codi? Si contestes que sí, mostra com
(no cal el codi complet) Si contestes que no, indica perquè?</li>
<li>Indica la diferència principal entre <em>Statement</em> i
<em>PreparedStatement</em>.</li>
<li>Perquè hi ha dos <em>try</em> al mètode <em>afegeixMoltsAnimals()</em>?</li>
<li>Què volen dir els interrogants que apareixen a la comanda sql del
mètode <em>afegeixMoltsAnimals()</em>?</li>
<li>Explica quin és l'objectiu que persegueixen les crides als mètodes
<em>getAutoCommit()</em> i <em>setAutoCommit()</em> al mètode
<em>afegeixMoltsAnimals()</em>.</li>
<li>Al mètode <em>afegeixMoltsAnimals()</em> què ha de passar perquè s'executi
la crida al mètode <em>commit()</em>? i què per què s'executi
<em>rollback()</em>?</li>
<li>La documentació del mètode <em>rollback()</em> ens indica que només hem de
fer servir aquest mètode quan tenim <em>autocomit</em> inhabilitat. El
codi anterior respecta aquest <em>contracte</em>?</li>
<li>Què fan les crides al mètode <em>setString()</em> a
<em>afegeixMoltsAnimals()</em>?</li>
<li>Com es pot saber a quants registres ha afectat l'execució d'una
comanda de modificació?</li>
<li>Fixa't que cada animal que es guarda a la base de dades disposa
d'un identificador (la clau primària de la taula). Tal i com s'ha
definit aquest programa, qui posa l'identificador dels animals, el
codi o el SGBD? Com podem fer que l'altre part se n'assabenti?
Podríem fer-ho a l'inrevés? És a dir, podria ser la part que no
assigna ara l'identificador qui l'assignés? Quines implicacions
tindria? Què consideres més adequat? Perquè?</li>
</ol>
</div>
</div>
</div>
<div class="well small">
<ul id="navigation"> 
    <li class="navigation-prev">
    <a href="./primeres-consultes-a-postgresql.html">
        Primeres consultes a PostGreSQL
    </a>
    </li>

    <li class="navigation-top">
    <a href="./jdbc-i-introduccio-al-jdbc.html">
        inici
    </a>
    </li>

    <li class="navigation-next">
    <a href="./jdbc-iii-model-objecte-relacional.html">
        JDBC III. Model Objecte-Relacional
    </a>
    </li>
</ul> 
</div>
</div>
<footer>
  <p>
  <a href=".">Apunts tècnics</a> 
  &copy; 
  <a href="http://www.gnu.org/copyleft/fdl.html">GNU FDL</a>
  per <i>Moisès Gómez Girón </i> (<img style="position:relative;top:+5px;border:0; display:inline;" src="./images/adressamoi.png">)
  amb el generador de blocs <a href="http://getpelican.com/">Pelican</a> 
  </p>
</footer>    </div>
</div>

</body>
</html>